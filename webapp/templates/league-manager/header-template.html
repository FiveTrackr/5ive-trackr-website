<!-- League Manager Header Template -->
<!-- This template copies the exact header structure from pitches.html -->
<!-- The title will be dynamically updated based on the page -->

<div class="header-left">
    <h1 class="page-title" data-page-title>Dashboard</h1>
</div>

<div class="header-right">
    <!-- User Info Section -->
    <div class="user-info">
        <div class="user-avatar" data-user-initials>--</div>
        <div class="user-details">
            <div class="user-name" data-user-name>Loading...</div>
            <div class="user-role" data-user-role>Loading...</div>
        </div>
    </div>

    <!-- Header Actions -->
    <div class="header-actions">
        <button class="header-btn notifications-btn" onclick="toggleNotificationsPanel()">
            <span class="btn-icon">ðŸ””</span>
            <span class="btn-text">Notifications</span>
            <span class="notification-badge" id="notification-count">3</span>
        </button>
    </div>
</div>

<!-- Notifications Panel -->
<div class="notifications-panel" id="notifications-panel">
    <div class="notifications-header">
        <h3>Notifications</h3>
        <div class="notifications-actions">
            <button class="btn-text mark-all-read" onclick="markAllNotificationsRead()">Mark all as read</button>
            <button class="close-panel" onclick="closeNotificationsPanel()">&times;</button>
        </div>
    </div>
    <div class="notifications-content">
        <div class="notifications-list" id="notifications-list">
            <!-- Notifications will be loaded here -->
        </div>
    </div>
</div>

<!-- Notifications Panel Overlay -->
<div class="notifications-overlay" id="notifications-overlay" onclick="closeNotificationsPanel()"></div>

<style>
/* Notifications Button Styling */
.notifications-btn {
    position: relative;
}

.notification-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #dc2626;
    color: white;
    border-radius: 50%;
    padding: 0;
    font-size: 10px;
    font-weight: 600;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
}

.notification-badge.hidden {
    display: none;
}

/* Notifications Panel Styling */
.notifications-panel {
    position: fixed;
    top: 80px;
    right: 20px;
    width: 400px;
    max-width: 90vw;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    z-index: 1001;
    max-height: 70vh;
    display: none;
    flex-direction: column;
    border: 1px solid #e0e0e0;
}

.notifications-panel.active {
    display: flex;
}

.notifications-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.3);
    z-index: 1000;
    display: none;
}

.notifications-overlay.active {
    display: block;
}

.notifications-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #e0e0e0;
    background: #f8f9fa;
    border-radius: 12px 12px 0 0;
}

.notifications-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
}

.notifications-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.mark-all-read {
    color: #2e6417;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
}

.mark-all-read:hover {
    text-decoration: underline;
}

.close-panel {
    background: none;
    border: none;
    font-size: 24px;
    color: #666;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-panel:hover {
    color: #333;
}

.notifications-content {
    flex: 1;
    overflow-y: auto;
    max-height: calc(70vh - 80px);
}

.notifications-list {
    padding: 8px 0;
}

/* Individual Notification Styling */
.notification-item {
    display: flex;
    align-items: flex-start;
    padding: 12px 20px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background-color 0.2s ease;
    position: relative;
}

.notification-item:hover {
    background-color: #f8f9fa;
}

.notification-item.unread {
    background-color: #f0f8ff;
    border-left: 4px solid #2e6417;
}

.notification-item.unread::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 18px;
    width: 8px;
    height: 8px;
    background: #2e6417;
    border-radius: 50%;
}

.notification-icon {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 16px;
}

.notification-icon.urgent {
    background: #ff4444;
    color: white;
}

.notification-icon.info {
    background: #2196f3;
    color: white;
}

.notification-icon.success {
    background: #4caf50;
    color: white;
}

.notification-icon.warning {
    background: #ff9800;
    color: white;
}

.notification-content {
    flex: 1;
    min-width: 0;
}

.notification-title {
    font-weight: 600;
    font-size: 14px;
    color: #333;
    margin: 0 0 4px 0;
    line-height: 1.3;
}

.notification-description {
    font-size: 13px;
    color: #666;
    margin: 0 0 6px 0;
    line-height: 1.4;
}

.notification-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #999;
}

.notification-time {
    font-size: 11px;
    color: #999;
}

.notification-actions {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.notification-btn {
    padding: 4px 8px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.notification-btn.primary {
    background: #2e6417;
    color: white;
    border-color: #2e6417;
}

.notification-btn:hover {
    background: #f0f0f0;
}

.notification-btn.primary:hover {
    background: #1e4009;
}

/* Empty state */
.notifications-empty {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.notifications-empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}
</style>

<script>
// League Manager Header Template - Dynamic Content Loading
(function() {
    'use strict';
    
    // Page titles mapping for each league manager page
    const PAGE_TITLES = {
        'dashboard': 'Dashboard',
        'teams': 'Teams',
        'leagues': 'Leagues', 
        'divisions': 'Divisions',
        'fixtures': 'Fixtures',
        'referees': 'Referees',
        'pitches': 'Pitches',
        'team-payments': 'Team Payments',
        'settings': 'Settings'
    };
    
    // Load user data and update header
    async function loadUserData() {
        try {
            // Check if UserDataManager is available
            if (typeof window.UserDataManager !== 'undefined') {
                const userData = await window.UserDataManager.load();
                if (userData && userData.currentUser) {
                    updateUserDisplay(userData.currentUser);
                    return;
                }
            }
            
            // Try SessionManager if available
            if (typeof window.SessionManager !== 'undefined' && window.SessionManager.isLoggedIn()) {
                const currentUser = window.SessionManager.getCurrentUser();
                if (currentUser) {
                    updateUserDisplay(currentUser);
                    return;
                }
            }
            
            // Fallback: Try to load from localStorage
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                const user = JSON.parse(currentUser);
                updateUserDisplay(user);
                return;
            }
            
            // Final fallback: Use session data or default
            const sessionData = localStorage.getItem('sessionData');
            if (sessionData) {
                const session = JSON.parse(sessionData);
                if (session.user) {
                    updateUserDisplay(session.user);
                    return;
                }
            }
            
            // Default fallback data
            updateUserDisplay({
                name: 'League Manager',
                role: 'Administrator',
                initials: 'LM'
            });
            
        } catch (error) {
            console.error('Error loading user data in header template:', error);
            // Use default data on error
            updateUserDisplay({
                name: 'League Manager',
                role: 'Administrator', 
                initials: 'LM'
            });
        }
    }
    
    // Update user display elements
    function updateUserDisplay(user) {
        // Update user name - prioritize full name over email
        const userNameElements = document.querySelectorAll('[data-user-name]');
        userNameElements.forEach(element => {
            // Look for full name first, then fallback to username, avoid showing email as name
            const displayName = user.fullName || user.name || user.firstName || user.username || 'League Manager';
            element.textContent = displayName;
        });
        
        // Update user role - use the actual assigned role
        const userRoleElements = document.querySelectorAll('[data-user-role]');
        userRoleElements.forEach(element => {
            // Look for various role field names and clean up the display
            let displayRole = user.role || user.userRole || user.accountType || 'Administrator';
            
            // Clean up role display (convert snake_case to proper case)
            if (displayRole === 'league_manager') {
                displayRole = 'League Manager';
            } else if (displayRole === 'team_manager') {
                displayRole = 'Team Manager';
            } else if (displayRole === 'referee') {
                displayRole = 'Referee';
            } else if (displayRole === 'admin') {
                displayRole = 'Administrator';
            }
            
            element.textContent = displayRole;
        });
        
        // Update user initials - use full name for initials, not email
        const userInitialsElements = document.querySelectorAll('[data-user-initials]');
        userInitialsElements.forEach(element => {
            const nameForInitials = user.fullName || user.name || user.firstName || user.username || 'League Manager';
            const initials = user.initials || generateInitials(nameForInitials);
            element.textContent = initials;
        });
    }
    
    // Generate initials from name
    function generateInitials(name) {
        if (!name) return 'LM';
        
        // Don't generate initials from email addresses
        if (name.includes('@')) {
            return 'LM'; // Default to League Manager initials for email addresses
        }
        
        const nameParts = name.trim().split(' ');
        if (nameParts.length === 1) {
            return nameParts[0].substring(0, 2).toUpperCase();
        } else {
            return (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase();
        }
    }
    
    // Update page title based on current page
    function updatePageTitle() {
        const pageTitleElement = document.querySelector('[data-page-title]');
        if (pageTitleElement) {
            const currentPage = getCurrentPageName();
            if (currentPage && PAGE_TITLES[currentPage]) {
                pageTitleElement.textContent = PAGE_TITLES[currentPage];
            } else if (currentPage) {
                // Fallback: capitalize first letter
                pageTitleElement.textContent = currentPage.charAt(0).toUpperCase() + currentPage.slice(1);
            }
        }
    }
    
    // Get current page name from URL
    function getCurrentPageName() {
        const path = window.location.pathname;
        const filename = path.split('/').pop();
        const pageName = filename.replace('.html', '');
        
        // Handle special cases for compound names
        if (pageName.includes('-')) {
            return pageName; // Keep as-is for team-payments etc.
        }
        
        return pageName.toLowerCase();
    }
    
    // Initialize header template
    function initializeHeaderTemplate() {
        console.log('Header template initializing...');
        
        // Update page title immediately
        updatePageTitle();
        
        // Load user data
        loadUserData();
        
        // Dispatch custom event to notify page that header is loaded
        document.dispatchEvent(new CustomEvent('headerLoaded', {
            detail: {
                template: 'league-manager-header',
                timestamp: new Date().toISOString()
            }
        }));
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeHeaderTemplate);
    } else {
        initializeHeaderTemplate();
    }
    
    // Also initialize immediately for dynamic loading
    setTimeout(initializeHeaderTemplate, 10);
    
    // Force immediate page title update when this script runs
    setTimeout(updatePageTitle, 1);
    
    // Make functions available globally for external access
    window.leagueManagerHeader = {
        updatePageTitle: updatePageTitle,
        updateUserData: loadUserData,
        setPageTitle: function(pageName) {
            const pageTitleElement = document.querySelector('[data-page-title]');
            if (pageTitleElement && PAGE_TITLES[pageName]) {
                pageTitleElement.textContent = PAGE_TITLES[pageName];
            }
        }
    };
    
})();

// Simple Notifications System - Placeholder for future implementation
function toggleNotificationsPanel() {
    console.log('Notifications panel clicked - feature coming soon');
    alert('Notifications feature coming soon!');
}

function closeNotificationsPanel() {
    console.log('Close notifications panel');
}

function markAllNotificationsRead() {
    console.log('Mark all notifications as read');
}
</script>
