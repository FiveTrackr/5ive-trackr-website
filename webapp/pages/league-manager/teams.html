<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teams - 5ive Trackr</title>
    <meta name="author" content="5ive Trackr">
    <meta name="copyright" content="Â© 2025 5ive Trackr. All rights reserved.">
    <meta name="robots" content="noarchive, noimageindex">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    
    <!-- Consolidated Dashboard Master CSS -->
    <link rel="stylesheet" href="../../css/dashboard-master.css?v=consolidated-2025">
    <style>
    /* Safe system font stack - no external dependencies */
    body, * {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, Roboto, "Noto Sans", "Liberation Sans", sans-serif;
    }
</style>
    <!-- League Manager Sidebar Styles - Load immediately to prevent layout shifts -->
    <link rel="stylesheet" href="../../css/league-manager-sidebar.css">
    <!-- League Manager Header Styles - Load immediately to prevent layout shifts -->
    <link rel="stylesheet" href="../../css/league-manager-header.css">
    <!-- Teams Enhanced Layout & Design -->
    <link rel="stylesheet" href="../../css/teams-layout.css?v=enhanced-2025">
    
    <style>
        /* Header Template Styles */
        .main-header[data-loaded="league-manager"] {
            background-color: #ffffff !important;
            border-radius: 0 0 12px 12px !important;
            padding: 16px 24px !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            width: calc(100% - 250px) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            position: fixed !important;
            top: 0 !important;
            left: 250px !important;
            z-index: 999 !important;
            height: 70px !important;
            box-sizing: border-box !important;
        }

        /* Notifications Button Styling */
        .notifications-btn {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc2626;
            color: white;
            border-radius: 50%;
            padding: 0;
            font-size: 10px;
            font-weight: 600;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        .notification-badge.hidden {
            display: none;
        }

        /* Notifications Panel Styling */
        .notifications-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 400px;
            max-width: 90vw;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1001;
            max-height: 70vh;
            display: none;
            flex-direction: column;
            border: 1px solid #e0e0e0;
        }

        .notifications-panel.active {
            display: flex;
        }

        .notifications-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        .notifications-overlay.active {
            display: block;
        }

        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .notifications-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .notifications-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mark-all-read {
            color: #2e6417;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }

        .mark-all-read:hover {
            text-decoration: underline;
        }

        .close-panel {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-panel:hover {
            color: #333;
        }

        .notifications-content {
            flex: 1;
            overflow-y: auto;
            max-height: calc(70vh - 80px);
        }

        .notifications-list {
            padding: 8px 0;
        }

        /* Teams Page Specific Styles - Matching Pitches Page */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f3f4f6;
        }
        
        .page-title-section {
            flex: 1;
        }
        
        .page-title, .content-title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #2e6417 0%, #1e4009 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0 0 4px 0;
        }
        
        .page-subtitle {
            color: #6b7280;
            font-size: 16px;
            margin: 0;
        }
        
        .page-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-decoration: none;
            font-family: 'Inter', sans-serif;
        }
        
        .btn-primary {
            background-color: #2e6417;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1e4009;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .btn-secondary:hover {
            background-color: #e9ecef;
        }
        
        .btn-icon {
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
        }
        
        /* Professional CSS Icons */
        .btn-icon.icon-export::before {
            content: "ðŸ“‹";
            font-style: normal;
        }
        
        .btn-icon.icon-create::before {
            content: "ï¼‹";
            font-style: normal;
            font-weight: bold;
        }
        
        /* Enhanced Primary Button */
        .btn-primary {
            background: linear-gradient(135deg, #2e6417 0%, #1e4009 100%);
            border: none;
            box-shadow: 0 2px 4px rgba(46, 100, 23, 0.2);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1e4009 0%, #2e6417 100%);
            box-shadow: 0 4px 8px rgba(46, 100, 23, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(46, 100, 23, 0.2);
        }
        
        /* Enhanced Secondary Button */
        .btn-secondary:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: none;
        }
        
        /* Danger Button */
        .btn-danger {
            background-color: #dc2626;
            color: white;
            border: none;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
            transform: translateY(-1px);
        }
        
        .btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
        }
        
        /* Overview Cards Styling Improvements */
        .overview-cards .card-icon {
            font-size: 20px; /* Reduced from default size */
        }
        
        .overview-cards .card-value {
            font-size: 24px; /* Reduced from default size */
            font-weight: 700;
        }
        
        .overview-cards .card-title {
            font-size: 14px;
            font-weight: 500;
        }

        /* Venue Selector Styles */
        .venue-selector-container {
            padding: 0 15px 20px 15px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 16px;
            position: relative;
            overflow: visible;
        }

        .venue-selector-btn {
            width: 100% !important;
            background: linear-gradient(135deg, #2e6417 0%, #1e4009 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: none !important;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(46, 100, 23, 0.2);
            position: relative;
            box-sizing: border-box !important;
            margin: 0 !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
        }

        .venue-selector-btn:hover {
            transform: none !important;
            box-shadow: 0 2px 4px rgba(46, 100, 23, 0.2) !important;
        }

        .venue-selector-btn:active {
            transform: none !important;
        }

        .venue-selector-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
        }

        .venue-selector-label {
            font-size: 0.7rem;
            opacity: 0.9;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .venue-selector-name {
            font-size: 0.875rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .venue-selector-icon {
            font-size: 1rem;
            margin-left: 8px;
            transition: none !important;
        }

        .venue-selector-btn.active .venue-selector-icon {
            transform: rotate(180deg) !important;
            transition: none !important;
        }

        .venue-selector-btn.active {
            border-radius: 8px 8px 0 0 !important;
            border-bottom: none !important;
            box-shadow: 0 2px 4px rgba(46, 100, 23, 0.2) !important;
            transition: none !important;
        }

        .venue-dropdown {
            position: absolute;
            top: calc(100% - 1px);
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2e6417 0%, #1e4009 100%);
            border: none !important;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            z-index: 9999 !important;
            margin-top: 0;
            transform: none !important;
            transition: none !important;
            display: none;
            max-height: 300px;
            overflow-y: auto;
            color: white;
            outline: none !important;
        }

        .venue-dropdown.show {
            display: block !important;
            transition: none !important;
        }

        /* Venue Selector Overlay - Only darken area outside dropdown */
        .venue-selector-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9998 !important;
            display: none;
            transition: none !important;
        }

        .venue-selector-overlay.show {
            display: block !important;
            transition: none !important;
        }

        .venue-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: none !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            background: transparent;
        }

        .venue-option:last-child {
            border-bottom: none;
        }

        .venue-option:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            transition: none !important;
        }

        .venue-option.selected {
            background: rgba(255, 255, 255, 0.2) !important;
            color: white;
            font-weight: 700;
            transition: none !important;
        }

        .venue-option-details {
            display: flex;
            flex-direction: column;
        }

        .venue-option-name {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 2px;
            color: white;
        }

        .venue-option-address {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .venue-option-check {
            color: white;
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Navigation Icon Fixes */
        body[data-role="league-manager"] .sidebar .nav-icon[data-icon="referee"],
        .sidebar .nav-icon[data-icon="referee"] {
            background-image: url('../../img/referee-icon.svg') !important;
            background-size: 18px 18px !important;
            background-repeat: no-repeat !important;
            background-position: center !important;
            width: 20px !important;
            height: 20px !important;
            display: inline-block !important;
        }

        body[data-role="league-manager"] .sidebar .nav-icon[data-icon="shirt"],
        .sidebar .nav-icon[data-icon="shirt"] {
            background-image: url('../../img/shirt-icon.svg') !important;
            background-size: 18px 18px !important;
            background-repeat: no-repeat !important;
            background-position: center !important;
            width: 20px !important;
            height: 20px !important;
            display: inline-block !important;
        }

        /* Navigation Sizing Fix Applied: Consistent padding (14px 20px) for all nav items via league-manager-sidebar.css */
    </style>
    
    <!-- Authentication System -->
    <script src="../../js/core/auth.js"></script>`n    <script src="../../js/core/session-manager.js"></script>
    <!-- <script src="../../js/core/session-protection.js"></script> -->
    <\!-- SPA Redirect Handler -->
    <script src="../../js/core/spa-redirect.js"></script>
</head>
<body data-page="teams" data-role="league-manager">
    <!-- Sidebar - Static content with dynamic enhancement -->
    <aside class="sidebar">
        <!-- Static sidebar content that loads immediately -->
        <div class="sidebar-header">
            <div class="logo-container">
                <img src="../../img/header-logo.svg" alt="5ive Trackr" class="logo">
            </div>
        </div>

        <!-- Navigation Menu -->
        <nav class="sidebar-nav">
            <!-- Venue Selector -->
            <div class="venue-selector-container">
                <div class="venue-selector-btn" id="venue-selector-btn" onclick="toggleVenueDropdown()">
                    <div class="venue-selector-content">
                        <div class="venue-selector-label">Current Venue</div>
                        <div class="venue-selector-name" id="selected-venue-name">Loading...</div>
                    </div>
                    <span class="venue-selector-icon">â–¼</span>
                    <div class="venue-dropdown" id="venue-dropdown">
                        <!-- Data will be loaded dynamically based on logged-in user -->
                        <div class="venue-option" data-venue-id="VEN002" onclick="selectVenue('VEN002', 'Elite Sports Center', '456 Championship Drive', event)">
                            <div class="venue-option-details">
                                <div class="venue-option-name">Elite Sports Center</div>
                                <div class="venue-option-address">456 Championship Drive</div>
                            </div>
                            <span class="venue-option-check" style="display: none;">âœ“</span>
                        </div>
                        <div class="venue-option" data-venue-id="VEN003" onclick="selectVenue('VEN003', 'Premier League Complex', '789 Victory Boulevard', event)">
                            <div class="venue-option-details">
                                <div class="venue-option-name">Premier League Complex</div>
                                <div class="venue-option-address">789 Victory Boulevard</div>
                            </div>
                            <span class="venue-option-check" style="display: none;">âœ“</span>
                        </div>
                        <div class="venue-option" data-venue-id="VEN001" onclick="selectVenue('VEN001', 'Sports Arena West', '123 Athletic Avenue', event)">
                            <div class="venue-option-details">
                                <div class="venue-option-name">Sports Arena West</div>
                                <div class="venue-option-address">123 Athletic Avenue</div>
                            </div>
                            <span class="venue-option-check" style="display: none;">âœ“</span>
                        </div>
                        <!-- END MOCK DATA -->
                    </div>
                </div>
            </div>

            <!-- Venue Selector Overlay -->
            <div class="venue-selector-overlay" id="venue-selector-overlay" onclick="closeVenueDropdown()"></div>

            <ul class="nav-menu">
                <li class="nav-item" data-page="dashboard">
                    <a href="dashboard.html" class="nav-link">
                        <span class="nav-icon">ðŸ“Š</span>
                        <span class="link-text">Dashboard</span>
                    </a>
                </li>
                
                <li class="nav-item" data-page="fixtures">
                    <a href="fixtures.html" class="nav-link">
                        <span class="nav-icon">ðŸ“…</span>
                        <span class="link-text">Fixtures</span>
                    </a>
                </li>
                
                <li class="nav-item" data-page="referees">
                    <a href="referees.html" class="nav-link">
                        <span class="nav-icon" data-icon="referee"></span>
                        <span class="link-text">Referees</span>
                    </a>
                </li>
                
                <li class="nav-item" data-page="divisions">
                    <a href="divisions.html" class="nav-link">
                        <span class="nav-icon">ðŸ“‹</span>
                        <span class="link-text">Divisions</span>
                    </a>
                </li>
                
                <li class="nav-item" data-page="leagues">
                    <a href="leagues.html" class="nav-link">
                        <span class="nav-icon">ðŸ†</span>
                        <span class="link-text">Leagues</span>
                    </a>
                </li>
                
                <li class="nav-item active" data-page="teams">
                    <a href="teams.html" class="nav-link">
                        <span class="nav-icon" data-icon="shirt"></span>
                        <span class="link-text">Teams</span>
                    </a>
                </li>
                
                <li class="nav-item" data-page="pitches">
                    <a href="pitches.html" class="nav-link">
                        <span class="nav-icon">ðŸ¥…</span>
                        <span class="link-text">Pitches</span>
                    </a>
                </li>
                
                <li class="nav-item" data-page="venues">
                    <a href="venues.html" class="nav-link">
                        <span class="nav-icon">ðŸŸï¸</span>
                        <span class="link-text">Venues</span>
                    </a>
                </li>
                
                <li class="nav-item" data-page="payments">
                    <a href="team-payments.html" class="nav-link">
                        <span class="nav-icon">ðŸ’³</span>
                        <span class="link-text">Team Payments</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <div class="footer-section footer-actions">
                <a href="settings.html" class="footer-link">
                    <span class="footer-icon">âš™ï¸</span>
                    <span class="footer-text">Settings</span>
                </a>
                <a href="#" class="footer-link" onclick="handleLogout(event)">
                    <span class="footer-icon">ðŸšª</span>
                    <span class="footer-text">Logout</span>
                </a>
            </div>
        </div>
    </aside>

    <!-- League Manager Header Template -->
    <header class="main-header" data-loaded="league-manager">
        <div class="header-left">
            <h1 class="page-title" data-page-title>Teams</h1>
        </div>

        <div class="header-right">
            <!-- User Info Section -->
            <div class="user-info"> data-user-name
                <div class="user-avatar" data-user-initials> data-user-name--</div>
                <div class="user-details"> data-user-name
                    <div class="user-name" data-user-name> data-user-nameLoading...</div>
                    <div class="user-role" data-user-role> data-user-role data-user-nameLoading...</div>
                </div>
            </div>

            <!-- Header Actions -->
            <div class="header-actions">
                <button class="header-btn notifications-btn" onclick="toggleNotificationsPanel()">
                    <span class="btn-icon">ðŸ””</span>
                    <span class="btn-text">Notifications</span>
                    <span class="notification-badge" id="notification-count">3</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Notifications Panel -->
    <div class="notifications-panel" id="notifications-panel">
        <div class="notifications-header">
            <h3>Notifications</h3>
            <div class="notifications-actions">
                <button class="btn-text mark-all-read" onclick="markAllNotificationsRead()">Mark all as read</button>
                <button class="close-panel" onclick="closeNotificationsPanel()">&times;</button>
            </div>
        </div>
        <div class="notifications-content">
            <div class="notifications-list" id="notifications-list">
                <!-- Notifications will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Notifications Panel Overlay -->
    <div class="notifications-overlay" id="notifications-overlay" onclick="closeNotificationsPanel()"></div>

    <!-- Main Content Area -->
    <main class="main-content">
        <div class="content-area">
            <!-- Teams Management Section -->
            <div class="page-header">
                <div class="page-title-section">
                    <h1 class="content-title">Team Management</h1>
                    <p class="page-subtitle">Manage team registrations, contact information, and league assignments</p>
                </div>
                <div class="page-actions">
                    <button class="btn btn-secondary" onclick="exportTeamsData()">
                        <span class="btn-icon">ðŸ“Š</span>
                        <span class="btn-text">Export Data</span>
                    </button>
                    <button class="btn btn-secondary" onclick="openImportTeamsModal()">
                        <span class="btn-icon">ðŸ“¥</span>
                        <span class="btn-text">Import Teams</span>
                    </button>
                    <button class="btn btn-primary" onclick="openAddTeamModal()"
                            aria-label="Create new team"
                            title="Add a new team">
                        <span class="btn-icon icon-create" aria-hidden="true"></span>
                        <span class="btn-text">Add Team</span>
                    </button>
                </div>
            </div>

            <!-- Teams Overview Cards -->
            <div class="overview-cards">
                <div class="overview-card">
                    <div class="card-icon">ðŸ‘¥</div>
                    <div class="card-content">
                        <div class="card-title">Total Teams</div>
                        <div class="card-value" id="totalTeamsCount">0</div>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="card-icon">â³</div>
                    <div class="card-content">
                        <div class="card-title">Waiting List</div>
                        <div class="card-value" id="waitingListCount">0</div>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="card-icon">ðŸ’³</div>
                    <div class="card-content">
                        <div class="card-title">Pay-Per-Game</div>
                        <div class="card-value" id="payPerGameCount">0</div>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="card-icon">ðŸ“…</div>
                    <div class="card-content">
                        <div class="card-title">Pay-Per-Season</div>
                        <div class="card-value" id="payPerSeasonCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Teams Management Controls -->
            <div class="management-controls">
                <div class="controls-left">
                    <div class="search-container">
                        <input type="text" id="teamSearchInput" placeholder="Search teams by name, captain, or contact..." class="search-input">
                        <span class="search-icon">ðŸ”</span>
                    </div>
                </div>
                <div class="controls-right">
                    <div class="filter-container">
                        <select id="statusFilter" class="filter-select">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="pending">Pending Registration</option>
                            <option value="waiting">Waiting List</option>
                        </select>
                    </div>
                    <div class="filter-container">
                        <select id="paymentFilter" class="filter-select">
                            <option value="">All Payment Types</option>
                            <option value="season">Season Payment</option>
                            <option value="pay-to-play">Pay-to-Play</option>
                        </select>
                    </div>
                    <div class="filter-container">
                        <select id="leagueFilter" class="filter-select">
                            <option value="">All Leagues</option>
                            <!-- Dynamic league options -->
                        </select>
                    </div>
                </div>
            </div>

            <!-- Teams List -->
            <div class="teams-container">
                <div class="teams-header">
                    <h3>Registered Teams</h3>
                    <div class="teams-count">
                        <span id="filteredTeamsCount">0</span> teams
                    </div>
                </div>
                
                <div class="teams-list" id="teamsList">
                    <!-- Teams will be dynamically populated -->
                </div>
                
                <!-- Empty State -->
                <div class="empty-state" id="teamsEmptyState" style="display: none;">
                    <div class="empty-icon">ðŸ‘¥</div>
                    <h3>No Teams Found</h3>
                    <p>No teams match your current search or filter criteria.</p>
                    <button class="btn btn-primary" onclick="openAddTeamModal()">
                        <span class="btn-text">Add First Team</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Team Modal -->
    <div class="modal-overlay" id="teamModalOverlay">
        <div class="modal-container large-modal">
            <div class="modal-header">
                <h3 id="teamModalTitle">Add New Team</h3>
                <button class="modal-close" onclick="closeTeamModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="teamForm" class="team-form">
                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h4>Basic Information</h4>
                            <p>Team name and league assignment</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="teamName" class="form-label required">Team Name</label>
                                <input type="text" id="teamName" name="teamName" class="form-input" required>
                                <div class="validation-message"></div>
                            </div>
                            <div class="form-group">
                                <label for="teamLeague" class="form-label required">League</label>
                                <select id="teamLeague" name="teamLeague" class="form-select" required>
                                    <option value="">Select League</option>
                                    <!-- Dynamic league options -->
                                </select>
                                <div class="validation-message"></div>
                            </div>
                            <div class="form-group">
                                <label for="teamStatus" class="form-label">Status</label>
                                <select id="teamStatus" name="teamStatus" class="form-select">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="pending">Pending Registration</option>
                                    <option value="waiting">Waiting List</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="teamAbbreviation" class="form-label">Team Abbreviation</label>
                                <input type="text" id="teamAbbreviation" name="teamAbbreviation" class="form-input" maxlength="5" placeholder="e.g., FCB">
                                <div class="validation-message"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Team Captain/Manager Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h4>Team Captain/Manager</h4>
                            <p>Primary contact person for team communications</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="captainName" class="form-label required">Captain Name</label>
                                <input type="text" id="captainName" name="captainName" class="form-input" required>
                                <div class="validation-message"></div>
                            </div>
                            <div class="form-group">
                                <label for="captainEmail" class="form-label required">Captain Email</label>
                                <input type="email" id="captainEmail" name="captainEmail" class="form-input" required>
                                <div class="validation-message"></div>
                            </div>
                            <div class="form-group">
                                <label for="captainPhone" class="form-label required">Captain Phone</label>
                                <input type="tel" id="captainPhone" name="captainPhone" class="form-input" required>
                                <div class="validation-message"></div>
                            </div>
                            <div class="form-group">
                                <label for="emergencyContact" class="form-label">Emergency Contact</label>
                                <input type="tel" id="emergencyContact" name="emergencyContact" class="form-input">
                                <div class="validation-message"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Information Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h4>Payment Information</h4>
                            <p>Payment structure and tracking</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="paymentType" class="form-label required">Payment Structure</label>
                                <select id="paymentType" name="paymentType" class="form-select" required>
                                    <option value="">Select Payment Type</option>
                                    <option value="season">Season Payment</option>
                                    <option value="pay-to-play">Pay-to-Play</option>
                                </select>
                                <div class="validation-message"></div>
                            </div>
                            <div class="form-group">
                                <label for="paymentStatus" class="form-label">Payment Status</label>
                                <select id="paymentStatus" name="paymentStatus" class="form-select">
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                    <option value="partial">Partial</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                            <div class="form-group" id="seasonAmountGroup" style="display: none;">
                                <label for="seasonAmount" class="form-label">Season Amount</label>
                                <input type="number" id="seasonAmount" name="seasonAmount" class="form-input" step="0.01" min="0">
                                <div class="validation-message"></div>
                            </div>
                            <div class="form-group" id="gameRateGroup" style="display: none;">
                                <label for="gameRate" class="form-label">Per Game Rate</label>
                                <input type="number" id="gameRate" name="gameRate" class="form-input" step="0.01" min="0">
                                <div class="validation-message"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Preferences Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h4>Team Preferences</h4>
                            <p>Time slots and communication preferences</p>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="preferredTimeSlots" class="form-label">Preferred Time Slots</label>
                                <div class="checkbox-group" id="preferredTimeSlots">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="timeSlots" value="morning">
                                        <span class="checkbox-text">Morning (9:00-12:00)</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="timeSlots" value="afternoon">
                                        <span class="checkbox-text">Afternoon (12:00-17:00)</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="timeSlots" value="evening">
                                        <span class="checkbox-text">Evening (17:00-21:00)</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="communicationPreferences" class="form-label">Communication Preferences</label>
                                <div class="checkbox-group" id="communicationPreferences">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="commPrefs" value="push" checked>
                                        <span class="checkbox-text">Push Notifications (Primary)</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="commPrefs" value="sms">
                                        <span class="checkbox-text">SMS Messages</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="commPrefs" value="email">
                                        <span class="checkbox-text">Email</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h4>Additional Information</h4>
                            <p>Notes and special requirements</p>
                        </div>
                        <div class="form-group">
                            <label for="teamNotes" class="form-label">Notes</label>
                            <textarea id="teamNotes" name="teamNotes" class="form-textarea" rows="3" placeholder="Any special requirements or notes about this team..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeTeamModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTeam()">
                    <span id="saveTeamText">Save Team</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Export Teams Modal -->
    <div class="modal-overlay" id="exportTeamsModalOverlay">
        <div class="modal-container medium-modal">
            <div class="modal-header">
                <h3>Export Teams Data</h3>
                <button class="modal-close" onclick="closeExportTeamsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="form-section">
                        <div class="section-header">
                            <h4>Export Options</h4>
                            <p>Choose what data to include in your export</p>
                        </div>
                        
                        <!-- Team Selection -->
                        <div class="form-group">
                            <label class="form-label">Teams to Export</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="exportAllTeams" checked onchange="toggleExportTeamSelection()">
                                    <span class="checkbox-text">All Teams</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="exportFilteredTeams" onchange="toggleExportTeamSelection()">
                                    <span class="checkbox-text">Currently Filtered Teams Only</span>
                                </label>
                            </div>
                        </div>

                        <!-- Data Fields -->
                        <div class="form-group">
                            <label class="form-label">Data to Include</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="exportBasicInfo" checked>
                                    <span class="checkbox-text">Basic Information</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="exportContactInfo" checked>
                                    <span class="checkbox-text">Contact Information</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="exportPaymentInfo" checked>
                                    <span class="checkbox-text">Payment Information</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="exportPreferences" checked>
                                    <span class="checkbox-text">Preferences</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="exportNotes">
                                    <span class="checkbox-text">Notes</span>
                                </label>
                            </div>
                        </div>

                        <!-- Export Format -->
                        <div class="form-group">
                            <label for="exportFormat" class="form-label">Export Format</label>
                            <select id="exportFormat" class="form-select">
                                <option value="csv">CSV (Spreadsheet)</option>
                                <option value="json">JSON (Data)</option>
                                <option value="html">HTML (Printable)</option>
                                <option value="xml">XML (Data Exchange)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeExportTeamsModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performTeamsExport()">
                    <span class="btn-icon">ðŸ“Š</span>
                    <span class="btn-text">Export Teams</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Team Details Modal -->
    <div class="modal-overlay" id="teamDetailsModalOverlay">
        <div class="modal-container large-modal">
            <div class="modal-header">
                <h3 id="teamDetailsTitle">Team Details</h3>
                <button class="modal-close" onclick="closeTeamDetailsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="teamDetailsContent">
                    <!-- Team details will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeTeamDetailsModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="editTeamFromDetails()">
                    <span class="btn-icon">âœï¸</span>
                    <span class="btn-text">Edit Team</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Import Teams Modal -->
    <div class="modal-overlay" id="importTeamsModalOverlay">
        <div class="modal-container large-modal">
            <div class="modal-header">
                <h3>Import Teams</h3>
                <button class="modal-close" onclick="closeImportTeamsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="import-options">
                    <div class="form-section">
                        <div class="section-header">
                            <h4>Import Source</h4>
                            <p>Import team data from external sources automatically</p>
                        </div>
                        
                        <!-- Import Type Selection -->
                        <div class="form-group">
                            <label class="form-label">Import Method</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="importType" value="url" checked onchange="handleImportTypeChange()">
                                    <span class="radio-text">Website URL</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="importType" value="file" onchange="handleImportTypeChange()">
                                    <span class="radio-text">Upload Document</span>
                                </label>
                            </div>
                        </div>

                        <!-- URL Input -->
                        <div class="form-group" id="urlInputGroup">
                            <label for="importUrl" class="form-label required">Website URL</label>
                            <input type="url" id="importUrl" class="form-input" placeholder="https://example.com/teams or league website">
                            <div class="form-help">Enter a URL that contains team information (league websites, team directories, etc.)</div>
                            <div class="validation-message"></div>
                        </div>

                        <!-- File Upload -->
                        <div class="form-group" id="fileInputGroup" style="display: none;">
                            <label for="importFile" class="form-label required">Upload Document</label>
                            <input type="file" id="importFile" class="form-input" accept=".pdf,.doc,.docx,.txt,.csv,.xlsx,.xls">
                            <div class="form-help">Supported formats: PDF, Word, Text, CSV, Excel</div>
                            <div class="validation-message"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-header">
                            <h4>League Assignment</h4>
                            <p>Choose which league(s) to import teams into</p>
                        </div>
                        
                        <!-- League Selection -->
                        <div class="form-group">
                            <label class="form-label">Target League(s)</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="leagueSelection" value="single" checked onchange="handleLeagueSelectionChange()">
                                    <span class="radio-text">Single League</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="leagueSelection" value="multiple" onchange="handleLeagueSelectionChange()">
                                    <span class="radio-text">Multiple Leagues (Auto-detect)</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="leagueSelection" value="new" onchange="handleLeagueSelectionChange()">
                                    <span class="radio-text">Create New League(s)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Single League Selection -->
                        <div class="form-group" id="singleLeagueGroup">
                            <label for="targetLeague" class="form-label required">Select League</label>
                            <select id="targetLeague" class="form-select">
                                <option value="">Choose existing league</option>
                                <!-- Dynamic league options -->
                            </select>
                            <div class="validation-message"></div>
                        </div>

                        <!-- Multiple League Options -->
                        <div class="form-group" id="multipleLeagueGroup" style="display: none;">
                            <label class="form-label">League Detection Options</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="autoDetectLeagues" checked>
                                    <span class="checkbox-text">Auto-detect league names from source</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="createMissingLeagues" checked>
                                    <span class="checkbox-text">Create leagues if they don't exist</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="mapToExistingLeagues">
                                    <span class="checkbox-text">Map to existing leagues when possible</span>
                                </label>
                            </div>
                        </div>

                        <!-- New League Options -->
                        <div class="form-group" id="newLeagueGroup" style="display: none;">
                            <label for="newLeagueName" class="form-label required">New League Name</label>
                            <input type="text" id="newLeagueName" class="form-input" placeholder="Enter league name">
                            <div class="validation-message"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-header">
                            <h4>Import Settings</h4>
                            <p>Configure how team data should be processed</p>
                        </div>
                        
                        <!-- Data Processing Options -->
                        <div class="form-group">
                            <label class="form-label">Data Processing</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="skipDuplicates" checked>
                                    <span class="checkbox-text">Skip duplicate team names</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="extractContactInfo" checked>
                                    <span class="checkbox-text">Auto-extract contact information</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="setDefaultStatus">
                                    <span class="checkbox-text">Set all imported teams as 'Pending'</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="previewBeforeImport" checked>
                                    <span class="checkbox-text">Preview data before importing</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enableSmartMatching" checked>
                                    <span class="checkbox-text">Enable intelligent team name matching</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="autoGenerateAbbreviations" checked>
                                    <span class="checkbox-text">Auto-generate team abbreviations</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="validateTeamNames" checked>
                                    <span class="checkbox-text">Validate and clean team names</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="enableErrorRecovery" checked>
                                    <span class="checkbox-text">Auto-retry failed imports</span>
                                </label>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <div class="form-group">
                            <label class="form-label">Advanced Options</label>
                            <div class="advanced-settings">
                                <div class="setting-row">
                                    <label for="minimumTeamNameLength" class="setting-label">Minimum Team Name Length</label>
                                    <input type="number" id="minimumTeamNameLength" value="3" min="2" max="50" class="setting-input">
                                </div>
                                <div class="setting-row">
                                    <label for="maximumTeamNameLength" class="setting-label">Maximum Team Name Length</label>
                                    <input type="number" id="maximumTeamNameLength" value="50" min="10" max="100" class="setting-input">
                                </div>
                                <div class="setting-row">
                                    <label for="importTimeout" class="setting-label">Import Timeout (seconds)</label>
                                    <input type="number" id="importTimeout" value="30" min="10" max="120" class="setting-input">
                                </div>
                                <div class="setting-row">
                                    <label for="retryAttempts" class="setting-label">Retry Attempts</label>
                                    <input type="number" id="retryAttempts" value="3" min="1" max="5" class="setting-input">
                                </div>
                            </div>
                        </div>

                        <!-- Default Payment Type -->
                        <div class="form-group">
                            <label for="defaultPaymentType" class="form-label">Default Payment Type</label>
                            <select id="defaultPaymentType" class="form-select">
                                <option value="">Leave unset</option>
                                <option value="season">Season Payment</option>
                                <option value="pay-to-play">Pay-to-Play</option>
                            </select>
                        </div>
                    </div>

                    <!-- Import Progress -->
                    <div class="form-section" id="importProgressSection" style="display: none;">
                        <div class="section-header">
                            <h4>Import Progress</h4>
                            <p id="importStatusText">Processing...</p>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="importProgressBar" style="width: 0%;"></div>
                            </div>
                            <div class="progress-text" id="importProgressText">0%</div>
                        </div>

                        <div class="import-log" id="importLog">
                            <!-- Import log messages will appear here -->
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="form-section" id="previewSection" style="display: none;">
                        <div class="section-header">
                            <h4>Import Preview</h4>
                            <p>Review detected teams before importing</p>
                        </div>
                        
                        <div class="preview-container">
                            <div class="preview-summary">
                                <span id="previewTeamCount">0</span> teams detected
                                <span id="previewLeagueCount">0</span> leagues identified
                            </div>
                            
                            <div class="preview-list" id="previewList">
                                <!-- Preview items will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeImportTeamsModal()">Cancel</button>
                <button type="button" class="btn btn-secondary" id="analyzeBtn" onclick="analyzeImportSource()">
                    <span class="btn-icon">ðŸ”</span>
                    <span class="btn-text">Analyze Source</span>
                </button>
                <button type="button" class="btn btn-primary" id="importBtn" onclick="performTeamsImport()" style="display: none;">
                    <span class="btn-icon">ðŸ“¥</span>
                    <span class="btn-text">Import Teams</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Dynamic Template Scripts -->
    <script src="../../js/components/league-manager-sidebar.js?v=<?php echo time(); ?>"></script>
    <script src="../../js/components/league-manager-header.js?v=<?php echo time(); ?>"></script>
    
    <!-- Teams Management Script -->
    <script>
        // Global variables
        let teamsData = [];
        let filteredTeamsData = [];
        let currentEditingTeam = null;
        let leaguesData = [];

        // Mock Teams Data for demonstration
        const mockTeamsData = [
            {
                id: 'team-001',
                name: 'Thunder Strikers',
                leagueId: 'PREM-001',
                captainName: 'Michael Thompson',
                captainEmail: 'michael.thompson@email.com',
                captainPhone: '+44 7700 900001',
                status: 'active',
                paymentType: 'season',
                paymentStatus: 'paid',
                abbreviation: 'THUN',
                emergencyContact: 'Sarah Thompson',
                emergencyPhone: '+44 7700 900002',
                registrationDate: '2024-01-15',
                notes: 'Strong defensive team, consistent performance',
                playerCount: 16,
                homeVenue: 'Central Park Pitch A'
            },
            {
                id: 'team-002',
                name: 'Lightning Bolts FC',
                leagueId: 'PREM-001',
                captainName: 'Emma Rodriguez',
                captainEmail: 'emma.rodriguez@email.com',
                captainPhone: '+44 7700 900003',
                status: 'active',
                paymentType: 'pay-to-play',
                paymentStatus: 'current',
                abbreviation: 'BOLT',
                emergencyContact: 'Carlos Rodriguez',
                emergencyPhone: '+44 7700 900004',
                registrationDate: '2024-01-20',
                notes: 'Fast-paced attacking style, excellent teamwork',
                playerCount: 14,
                homeVenue: 'Sports Complex Field 1'
            },
            {
                id: 'team-003',
                name: 'Phoenix United',
                leagueId: 'DIV1-001',
                captainName: 'James Wilson',
                captainEmail: 'james.wilson@email.com',
                captainPhone: '+44 7700 900005',
                status: 'active',
                paymentType: 'season',
                paymentStatus: 'paid',
                abbreviation: 'PHOE',
                emergencyContact: 'Lisa Wilson',
                emergencyPhone: '+44 7700 900006',
                registrationDate: '2024-01-18',
                notes: 'Experienced squad with strong leadership',
                playerCount: 18,
                homeVenue: 'Riverside Grounds'
            },
            {
                id: 'team-004',
                name: 'Crimson Wolves',
                leagueId: 'DIV1-001',
                captainName: 'Sophie Chen',
                captainEmail: 'sophie.chen@email.com',
                captainPhone: '+44 7700 900007',
                status: 'pending',
                paymentType: 'season',
                paymentStatus: 'pending',
                abbreviation: 'CRIM',
                emergencyContact: 'David Chen',
                emergencyPhone: '+44 7700 900008',
                registrationDate: '2024-02-01',
                notes: 'New team, pending final registration approval',
                playerCount: 12,
                homeVenue: 'Central Park Pitch B'
            },
            {
                id: 'team-005',
                name: 'Golden Eagles',
                leagueId: 'DIV2-001',
                captainName: 'Robert Martinez',
                captainEmail: 'robert.martinez@email.com',
                captainPhone: '+44 7700 900009',
                status: 'active',
                paymentType: 'pay-to-play',
                paymentStatus: 'current',
                abbreviation: 'GOLD',
                emergencyContact: 'Maria Martinez',
                emergencyPhone: '+44 7700 900010',
                registrationDate: '2024-01-22',
                notes: 'Consistent mid-table performers, good sportsmanship',
                playerCount: 15,
                homeVenue: 'Sports Complex Field 2'
            },
            {
                id: 'team-006',
                name: 'Silver Sharks',
                leagueId: 'DIV2-001',
                captainName: 'Rachel Anderson',
                captainEmail: 'rachel.anderson@email.com',
                captainPhone: '+44 7700 900011',
                status: 'active',
                paymentType: 'season',
                paymentStatus: 'paid',
                abbreviation: 'SILV',
                emergencyContact: 'Mark Anderson',
                emergencyPhone: '+44 7700 900012',
                registrationDate: '2024-01-25',
                notes: 'Strong finishing team, excellent goal scoring record',
                playerCount: 17,
                homeVenue: 'Westfield Sports Ground'
            },
            {
                id: 'team-007',
                name: 'Blue Typhoons',
                leagueId: 'DIV2-001',
                captainName: 'Kevin O\'Brien',
                captainEmail: 'kevin.obrien@email.com',
                captainPhone: '+44 7700 900013',
                status: 'waiting',
                paymentType: 'season',
                paymentStatus: 'pending',
                abbreviation: 'BLUE',
                emergencyContact: 'Patricia O\'Brien',
                emergencyPhone: '+44 7700 900014',
                registrationDate: '2024-02-05',
                notes: 'On waiting list for Division 2, ready to join if space opens',
                playerCount: 13,
                homeVenue: 'TBD'
            },
            {
                id: 'team-008',
                name: 'Green Hornets',
                leagueId: 'REC-001',
                captainName: 'Amanda Foster',
                captainEmail: 'amanda.foster@email.com',
                captainPhone: '+44 7700 900015',
                status: 'active',
                paymentType: 'pay-to-play',
                paymentStatus: 'current',
                abbreviation: 'HORN',
                emergencyContact: 'Steven Foster',
                emergencyPhone: '+44 7700 900016',
                registrationDate: '2024-01-30',
                notes: 'Recreational team focused on fun and fitness',
                playerCount: 20,
                homeVenue: 'Community Park'
            },
            {
                id: 'team-009',
                name: 'Red Dragons',
                leagueId: 'REC-001',
                captainName: 'Daniel Kim',
                captainEmail: 'daniel.kim@email.com',
                captainPhone: '+44 7700 900017',
                status: 'active',
                paymentType: 'season',
                paymentStatus: 'paid',
                abbreviation: 'DRAG',
                emergencyContact: 'Jenny Kim',
                emergencyPhone: '+44 7700 900018',
                registrationDate: '2024-01-28',
                notes: 'Mixed skill level team, very welcoming to new players',
                playerCount: 19,
                homeVenue: 'Recreation Center Field'
            },
            {
                id: 'team-010',
                name: 'Black Panthers',
                leagueId: 'PREM-001',
                captainName: 'Christopher Taylor',
                captainEmail: 'christopher.taylor@email.com',
                captainPhone: '+44 7700 900019',
                status: 'inactive',
                paymentType: 'season',
                paymentStatus: 'overdue',
                abbreviation: 'PANR',
                emergencyContact: 'Helen Taylor',
                emergencyPhone: '+44 7700 900020',
                registrationDate: '2024-01-12',
                notes: 'Currently inactive due to payment issues, previous strong performers',
                playerCount: 11,
                homeVenue: 'Central Park Pitch C'
            },
            {
                id: 'team-011',
                name: 'White Tigers',
                leagueId: 'DIV1-001',
                captainName: 'Ashley Johnson',
                captainEmail: 'ashley.johnson@email.com',
                captainPhone: '+44 7700 900021',
                status: 'active',
                paymentType: 'pay-to-play',
                paymentStatus: 'current',
                abbreviation: 'TIGR',
                emergencyContact: 'Ryan Johnson',
                emergencyPhone: '+44 7700 900022',
                registrationDate: '2024-02-02',
                notes: 'Aggressive playing style, strong in set pieces',
                playerCount: 16,
                homeVenue: 'Northside Athletic Field'
            },
            {
                id: 'team-012',
                name: 'Purple Storm',
                leagueId: 'REC-001',
                captainName: 'Jessica Brown',
                captainEmail: 'jessica.brown@email.com',
                captainPhone: '+44 7700 900023',
                status: 'active',
                paymentType: 'season',
                paymentStatus: 'paid',
                abbreviation: 'PURP',
                emergencyContact: 'Michael Brown',
                emergencyPhone: '+44 7700 900024',
                registrationDate: '2024-01-26',
                notes: 'Family-friendly team with focus on skill development',
                playerCount: 22,
                homeVenue: 'Family Sports Complex'
            }
        ];

        // Mock Leagues Data to support team display
        const mockLeaguesData = [
            {
                id: 'PREM-001',
                name: 'Premier League',
                division: 'Premier',
                season: '2024',
                status: 'active'
            },
            {
                id: 'DIV1-001',
                name: 'Division 1',
                division: 'Division 1',
                season: '2024',
                status: 'active'
            },
            {
                id: 'DIV2-001',
                name: 'Division 2',
                division: 'Division 2',
                season: '2024',
                status: 'active'
            },
            {
                id: 'REC-001',
                name: 'Recreation League',
                division: 'Recreation',
                season: '2024',
                status: 'active'
            }
        ];

        // Critical button functions - defined immediately for onclick access
        function exportTeamsData() {
            if (!teamsData || teamsData.length === 0) {
                showToast('No teams data to export', 'warning');
                return;
            }
            
            const dataStr = JSON.stringify(teamsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `teams-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Teams data exported successfully', 'success');
        }

        function openImportTeamsModal() {
            document.getElementById('importTeamsModalOverlay').classList.add('active');
            if (typeof populateLeagueOptions === 'function') populateLeagueOptions();
            if (typeof resetImportForm === 'function') resetImportForm();
        }

        function openAddTeamModal() {
            currentEditingTeam = null;
            document.getElementById('teamModalTitle').textContent = 'Add New Team';
            document.getElementById('saveTeamText').textContent = 'Save Team';
            
            // Reset form
            document.getElementById('teamForm').reset();
            
            // Populate league dropdown
            if (typeof populateLeagueDropdowns === 'function') populateLeagueDropdowns();
            
            // Show payment fields based on default selection
            if (typeof handlePaymentTypeChange === 'function') handlePaymentTypeChange();
            
            // Show modal
            document.getElementById('teamModalOverlay').classList.add('active');
        }

        // Make functions globally accessible immediately
        window.exportTeamsData = exportTeamsData;
        window.openImportTeamsModal = openImportTeamsModal;
        window.openAddTeamModal = openAddTeamModal;

        // Header Template JavaScript Functionality
        // Load user data and update header
        async function loadUserData() {
            try {
                // Check if UserDataManager is available
                if (typeof window.UserDataManager !== 'undefined') {
                    const userData = await window.UserDataManager.load();
                    if (userData && userData.currentUser) {
                        updateUserDisplay(userData.currentUser);
                        return;
                    }
                }
                
                // Try SessionManager if available
                if (typeof window.SessionManager !== 'undefined' && window.SessionManager.isLoggedIn()) {
                    const currentUser = window.SessionManager.getCurrentUser();
                    if (currentUser) {
                        updateUserDisplay(currentUser);
                        return;
                    }
                }
                
                // Fallback: Try to load from localStorage
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    updateUserDisplay(user);
                    return;
                }
                
                // Final fallback: Use session data or default
                const sessionData = localStorage.getItem('sessionData');
                if (sessionData) {
                    const session = JSON.parse(sessionData);
                    if (session.user) {
                        updateUserDisplay(session.user);
                        return;
                    }
                }
                
                // Default fallback data
                updateUserDisplay({
                    name: 'League Manager',
                    role: 'Administrator',
                    initials: 'LM'
                });
                
            } catch (error) {
                console.error('Error loading user data in header template:', error);
                updateUserDisplay({
                    name: 'League Manager',
                    role: 'Administrator', 
                    initials: 'LM'
                });
            }
        }
        
        // Update user display elements
        function updateUserDisplay(user) {
            // Update user name
            const userNameElements = document.querySelectorAll('[data-user-name]');
            userNameElements.forEach(element => {
                const displayName = user.fullName || user.name || user.firstName || user.username || 'League Manager';
                element.textContent = displayName;
            });
            
            // Update user role
            const userRoleElements = document.querySelectorAll('[data-user-role]');
            userRoleElements.forEach(element => {
                let displayRole = user.role || user.userRole || user.accountType || 'Administrator';
                if (displayRole === 'league_manager') {
                    displayRole = 'League Manager';
                } else if (displayRole === 'team_manager') {
                    displayRole = 'Team Manager';
                } else if (displayRole === 'referee') {
                    displayRole = 'Referee';
                } else if (displayRole === 'admin') {
                    displayRole = 'Administrator';
                }
                element.textContent = displayRole;
            });
            
            // Update user initials
            const userInitialsElements = document.querySelectorAll('[data-user-initials]');
            userInitialsElements.forEach(element => {
                const nameForInitials = user.fullName || user.name || user.firstName || user.username || 'League Manager';
                const initials = user.initials || generateInitials(nameForInitials);
                element.textContent = initials;
            });
        }
        
        // Generate initials from name
        function generateInitials(name) {
            if (!name) return 'LM';
            if (name.includes('@')) {
                return 'LM';
            }
            const nameParts = name.trim().split(' ');
            if (nameParts.length === 1) {
                return nameParts[0].substring(0, 2).toUpperCase();
            } else {
                return (nameParts[0].charAt(0) + nameParts[nameParts.length - 1].charAt(0)).toUpperCase();
            }
        }
        
        // Simple Notifications System - Placeholder for future implementation
        function toggleNotificationsPanel() {
            console.log('Notifications panel clicked - feature coming soon');
            alert('Notifications feature coming soon!');
        }

        function closeNotificationsPanel() {
            console.log('Close notifications panel');
        }

        function markAllNotificationsRead() {
            console.log('Mark all notifications as read');
        }

        // Venue Selector JavaScript Functions
        let currentVenueId = null;
        let currentVenueName = null;

        // Data loaded from server based on user permissions`n        const mockVenues = [
            { id: 'VEN001', name: 'Sports Arena West', address: '123 Athletic Avenue' },
            { id: 'VEN002', name: 'Elite Sports Center', address: '456 Championship Drive' },
            { id: 'VEN003', name: 'Premier League Complex', address: '789 Victory Boulevard' }
        ];

        function initializeVenueSelector() {
            console.log('Initializing venue selector for teams page');
            // Data loaded from server based on user permissions`n            const sortedVenues = mockVenues.sort((a, b) => a.name.localeCompare(b.name));
            if (sortedVenues.length > 0) {
                const firstVenue = sortedVenues[0];
                selectVenue(firstVenue.id, firstVenue.name, firstVenue.address, null, false);
            }
        }

        function toggleVenueDropdown() {
            const dropdown = document.getElementById('venue-dropdown');
            const btn = document.getElementById('venue-selector-btn');
            const overlay = document.getElementById('venue-selector-overlay');
            
            console.log('Toggle clicked', dropdown, btn, overlay); // Debug log
            
            if (dropdown && dropdown.classList.contains('show')) {
                console.log('Closing dropdown'); // Debug log
                closeVenueDropdown();
            } else {
                console.log('Opening dropdown'); // Debug log
                if (dropdown) dropdown.classList.add('show');
                if (btn) btn.classList.add('active');
                if (overlay) overlay.classList.add('show');
            }
        }

        function closeVenueDropdown() {
            const dropdown = document.getElementById('venue-dropdown');
            const btn = document.getElementById('venue-selector-btn');
            const overlay = document.getElementById('venue-selector-overlay');
            
            console.log('Closing dropdown function called'); // Debug log
            
            if (dropdown) dropdown.classList.remove('show');
            if (btn) btn.classList.remove('active');
            if (overlay) overlay.classList.remove('show');
        }

        function selectVenue(venueId, venueName, venueAddress, event, closeDropdown = true) {
            // Prevent event bubbling to parent button
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            // Update selected venue
            currentVenueId = venueId;
            currentVenueName = venueName;
            
            // Update button text
            document.getElementById('selected-venue-name').textContent = venueName;
            
            // Update option selection states
            document.querySelectorAll('.venue-option').forEach(option => {
                const checkmark = option.querySelector('.venue-option-check');
                if (option.dataset.venueId === venueId) {
                    option.classList.add('selected');
                    checkmark.style.display = 'block';
                } else {
                    option.classList.remove('selected');
                    checkmark.style.display = 'none';
                }
            });
            
            // Close dropdown if requested
            if (closeDropdown) {
                closeVenueDropdown();
            }
            
            // Filter data based on selected venue
            filterDataByVenue(venueId);
            
            console.log('Venue changed to:', venueName, '(ID:', venueId, ')');
        }

        function filterDataByVenue(venueId) {
            // This function would filter the teams data based on selected venue
            // Data loaded from server based on user permissions`n            console.log('Filtering teams data for venue:', venueId);
            
            // Example: Show/hide team rows based on venue
            // In a real implementation, this would filter the teams data
            console.log('Showing teams data for venue:', venueId);
            
            // You could update the teams table here to show only relevant data
            // updateTeamsTable(venueId);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('venue-dropdown');
            const btn = document.getElementById('venue-selector-btn');
            const overlay = document.getElementById('venue-selector-overlay');
            
            if (dropdown && btn && overlay &&
                !dropdown.contains(event.target) && 
                !btn.contains(event.target) &&
                !overlay.contains(event.target)) {
                closeVenueDropdown();
            }
        });

        // Set active navigation item
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize venue selector first
            initializeVenueSelector();
            
            // Load user data for header
            await loadUserData();
            
            // Initialize the teams management system
            initializeTeamsManagement();
            
            // Listen for sidebar load completion
            document.addEventListener('sidebarLoaded', function(e) {
                console.log('Dynamic sidebar loaded successfully:', e.detail);
                
                // Set active page for teams
                if (window.leagueManagerSidebar) {
                    setTimeout(() => {
                        window.leagueManagerSidebar.setActive('teams');
                        console.log('Teams set as active');
                    }, 100);
                }
            });
            
            // Listen for header load completion
            document.addEventListener('headerLoaded', function(e) {
                console.log('Dynamic header loaded successfully:', e.detail);
                
                // Update header page title for teams
                if (window.leagueManagerHeader) {
                    setTimeout(() => {
                        window.leagueManagerHeader.updatePageTitle('teams');
                        console.log('Header title set to Teams');
                    }, 100);
                }
            });
        });

        // Initialize Teams Management System
        async function initializeTeamsManagement() {
            console.log('Initializing teams management system...');
            
            try {
                // For demo purposes, use mock data directly
                teamsData = mockTeamsData;
                leaguesData = mockLeaguesData;
                filteredTeamsData = [...teamsData];
                
                console.log('Using mock teams data:', teamsData.length, 'teams');
                console.log('Using mock leagues data:', leaguesData.length, 'leagues');
                
                // Setup event listeners
                setupEventListeners();
                
                // Update UI
                updateOverviewCards();
                renderTeamsList();
                
                // Populate league dropdowns
                populateLeagueDropdowns();
                
                console.log('Teams management system initialized successfully');
            } catch (error) {
                console.error('Error initializing teams management:', error);
                showToast('Error loading teams data. Please refresh the page.', 'error');
            }
        }
        
        // Wait for UserDataManager to be available
        function waitForUserDataManager() {
            return new Promise((resolve, reject) => {
                const maxWait = 10000; // 10 seconds
                const interval = 100; // Check every 100ms
                let elapsed = 0;
                
                const checkForManager = () => {
                    if (window.UserDataManager) {
                        resolve();
                    } else if (elapsed >= maxWait) {
                        reject(new Error('UserDataManager not available after 10 seconds'));
                    } else {
                        elapsed += interval;
                        setTimeout(checkForManager, interval);
                    }
                };
                
                checkForManager();
            });
        }

        // Load leagues data for dropdowns
        async function loadLeaguesData() {
            try {
                const userData = await window.UserDataManager.load();
                leaguesData = userData.leagues || mockLeaguesData; // Use mock data if no real data
                
                // Populate league dropdowns
                populateLeagueDropdowns();
                
                console.log('Leagues data loaded:', leaguesData.length, 'leagues');
            } catch (error) {
                console.error('Error loading leagues data:', error);
                // Use mock data as fallback
                leaguesData = mockLeaguesData;
                populateLeagueDropdowns();
                console.log('Using mock leagues data:', leaguesData.length, 'leagues');
            }
        }

        // Populate league dropdown options
        function populateLeagueDropdowns() {
            const leagueSelects = ['teamLeague', 'leagueFilter'];
            
            leagueSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Clear existing options (except first)
                    const firstOption = select.firstElementChild;
                    select.innerHTML = '';
                    if (firstOption) {
                        select.appendChild(firstOption);
                    }
                    
                    // Add league options
                    leaguesData.forEach(league => {
                        const option = document.createElement('option');
                        option.value = league.id;
                        option.textContent = league.name;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Load teams data
        async function loadTeamsData() {
            try {
                const userData = await window.UserDataManager.load();
                teamsData = userData.teams || mockTeamsData; // Use mock data if no real data
                filteredTeamsData = [...teamsData];
                
                console.log('Teams data loaded:', teamsData.length, 'teams');
            } catch (error) {
                console.error('Error loading teams data:', error);
                // Use mock data as fallback
                teamsData = mockTeamsData;
                filteredTeamsData = [...teamsData];
                console.log('Using mock teams data:', teamsData.length, 'teams');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('teamSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', handleTeamSearch);
            }

            // Filter functionality
            const filters = ['statusFilter', 'paymentFilter', 'leagueFilter'];
            filters.forEach(filterId => {
                const filter = document.getElementById(filterId);
                if (filter) {
                    filter.addEventListener('change', handleTeamFilters);
                }
            });

            // Payment type change in modal
            const paymentTypeSelect = document.getElementById('paymentType');
            if (paymentTypeSelect) {
                paymentTypeSelect.addEventListener('change', handlePaymentTypeChange);
            }

            // Modal close on overlay click
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-overlay')) {
                    if (e.target.id === 'teamModalOverlay') closeTeamModal();
                    if (e.target.id === 'exportTeamsModalOverlay') closeExportTeamsModal();
                    if (e.target.id === 'teamDetailsModalOverlay') closeTeamDetailsModal();
                }
            });
        }

        // Handle team search
        function handleTeamSearch() {
            const searchTerm = document.getElementById('teamSearchInput').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredTeamsData = [...teamsData];
            } else {
                filteredTeamsData = teamsData.filter(team => {
                    return team.name.toLowerCase().includes(searchTerm) ||
                           team.captainName.toLowerCase().includes(searchTerm) ||
                           team.captainEmail.toLowerCase().includes(searchTerm) ||
                           team.captainPhone.includes(searchTerm);
                });
            }
            
            // Apply current filters
            applyTeamFilters();
            renderTeamsList();
        }

        // Handle team filters
        function handleTeamFilters() {
            applyTeamFilters();
            renderTeamsList();
        }

        // Apply team filters
        function applyTeamFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            const leagueFilter = document.getElementById('leagueFilter').value;
            
            let filtered = [...filteredTeamsData];
            
            if (statusFilter) {
                filtered = filtered.filter(team => team.status === statusFilter);
            }
            
            if (paymentFilter) {
                filtered = filtered.filter(team => team.paymentType === paymentFilter);
            }
            
            if (leagueFilter) {
                filtered = filtered.filter(team => team.leagueId === leagueFilter);
            }
            
            filteredTeamsData = filtered;
        }

        // Update overview cards
        function updateOverviewCards() {
            const totalTeams = teamsData.length;
            
            // Waiting List - teams with status "pending" or "waiting"
            const waitingListCount = teamsData.filter(team => 
                team.status === 'pending' || team.status === 'waiting'
            ).length;
            
            // Pay-Per-Game teams
            const payPerGameCount = teamsData.filter(team => 
                team.paymentType === 'pay-to-play' || team.paymentType === 'per-game'
            ).length;
            
            // Pay-Per-Season teams
            const payPerSeasonCount = teamsData.filter(team => 
                team.paymentType === 'season' || team.paymentType === 'per-season'
            ).length;

            // Update card values
            document.getElementById('totalTeamsCount').textContent = totalTeams;
            document.getElementById('waitingListCount').textContent = waitingListCount;
            document.getElementById('payPerGameCount').textContent = payPerGameCount;
            document.getElementById('payPerSeasonCount').textContent = payPerSeasonCount;
        }

        // Render teams list
        function renderTeamsList() {
            const teamsList = document.getElementById('teamsList');
            const emptyState = document.getElementById('teamsEmptyState');
            const filteredCount = document.getElementById('filteredTeamsCount');
            
            if (!teamsList) return;

            // Update filtered count
            if (filteredCount) {
                filteredCount.textContent = filteredTeamsData.length;
            }

            // Clear existing content
            teamsList.innerHTML = '';

            if (filteredTeamsData.length === 0) {
                teamsList.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }

            // Hide empty state and show list
            teamsList.style.display = 'block';
            if (emptyState) emptyState.style.display = 'none';

            // Create team cards
            filteredTeamsData.forEach(team => {
                const teamCard = createTeamCard(team);
                teamsList.appendChild(teamCard);
            });
        }

        // Create team card
        function createTeamCard(team) {
            const card = document.createElement('div');
            card.className = 'team-card';
            card.setAttribute('data-team-id', team.id);

            // Get league name
            const league = leaguesData.find(l => l.id === team.leagueId);
            const leagueName = league ? league.name : 'Unknown League';

            // Status badge class
            const statusClass = getStatusBadgeClass(team.status);
            const paymentClass = getPaymentBadgeClass(team.paymentStatus);

            card.innerHTML = `
                <div class="team-card-header">
                    <div class="team-basic-info">
                        <h4 class="team-name">${escapeHtml(team.name)}</h4>
                        <p class="team-league">${escapeHtml(leagueName)}</p>
                    </div>
                    <div class="team-badges">
                        <span class="badge ${statusClass}">${team.status}</span>
                        <span class="badge ${paymentClass}">${team.paymentStatus}</span>
                    </div>
                </div>
                
                <div class="team-card-content">
                    <div class="team-info-row">
                        <div class="info-item">
                            <span class="info-label">Captain:</span>
                            <span class="info-value">${escapeHtml(team.captainName)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email:</span>
                            <span class="info-value">${escapeHtml(team.captainEmail)}</span>
                        </div>
                    </div>
                    <div class="team-info-row">
                        <div class="info-item">
                            <span class="info-label">Phone:</span>
                            <span class="info-value">${escapeHtml(team.captainPhone)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Payment:</span>
                            <span class="info-value">${team.paymentType === 'season' ? 'Season Payment' : 'Pay-to-Play'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="team-card-actions">
                    <button class="btn btn-sm btn-secondary" onclick="viewTeamDetails('${team.id}')">
                        <span class="btn-icon">ðŸ‘ï¸</span>
                        <span class="btn-text">View</span>
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="editTeam('${team.id}')">
                        <span class="btn-icon">âœï¸</span>
                        <span class="btn-text">Edit</span>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTeam('${team.id}')">
                        <span class="btn-icon">ðŸ—‘ï¸</span>
                        <span class="btn-text">Delete</span>
                    </button>
                </div>
            `;

            return card;
        }

        // Get status badge class
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'active': return 'badge-success';
                case 'inactive': return 'badge-secondary';
                case 'pending': return 'badge-warning';
                default: return 'badge-secondary';
            }
        }

        // Get payment badge class
        function getPaymentBadgeClass(paymentStatus) {
            switch (paymentStatus) {
                case 'paid': return 'badge-success';
                case 'partial': return 'badge-warning';
                case 'overdue': return 'badge-danger';
                case 'pending': return 'badge-secondary';
                default: return 'badge-secondary';
            }
        }

        // Close team modal
        function closeTeamModal() {
            document.getElementById('teamModalOverlay').classList.remove('active');
            currentEditingTeam = null;
            clearValidationMessages();
        }

        // Handle payment type change
        function handlePaymentTypeChange() {
            const paymentType = document.getElementById('paymentType').value;
            const seasonAmountGroup = document.getElementById('seasonAmountGroup');
            const gameRateGroup = document.getElementById('gameRateGroup');
            
            if (paymentType === 'season') {
                seasonAmountGroup.style.display = 'block';
                gameRateGroup.style.display = 'none';
            } else if (paymentType === 'pay-to-play') {
                seasonAmountGroup.style.display = 'none';
                gameRateGroup.style.display = 'block';
            } else {
                seasonAmountGroup.style.display = 'none';
                gameRateGroup.style.display = 'none';
            }
        }

        // Save team
        async function saveTeam() {
            if (!validateTeamForm()) {
                return;
            }

            const formData = getTeamFormData();
            
            try {
                if (currentEditingTeam) {
                    // Update existing team
                    formData.id = currentEditingTeam.id;
                    formData.dateCreated = currentEditingTeam.dateCreated;
                    formData.dateModified = new Date().toISOString();
                    
                    const index = teamsData.findIndex(team => team.id === currentEditingTeam.id);
                    if (index !== -1) {
                        teamsData[index] = formData;
                    }
                } else {
                    // Create new team
                    formData.id = 'team_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    formData.dateCreated = new Date().toISOString();
                    formData.dateModified = new Date().toISOString();
                    
                    teamsData.push(formData);
                }

                // Save to UserDataManager with conflict checking
                await saveTeamsDataWithConflictCheck();
                
                // Update UI
                filteredTeamsData = [...teamsData];
                updateOverviewCards();
                renderTeamsList();
                
                closeTeamModal();
                showToast(currentEditingTeam ? 'Team updated successfully' : 'Team added successfully', 'success');
                
            } catch (error) {
                console.error('Error saving team:', error);
                showToast('Error saving team', 'error');
            }
        }

        // Save teams data with conflict checking
        async function saveTeamsDataWithConflictCheck() {
            try {
                // Load current data to check for conflicts
                const currentData = await window.UserDataManager.load();
                
                // Update teams in the data structure
                currentData.teams = teamsData;
                
                // Save with conflict detection
                const result = await window.UserDataManager.save(currentData);
                
                if (result.hasConflicts) {
                    console.warn('Data conflicts detected and resolved:', result.conflicts);
                    showToast('Data saved with conflict resolution', 'warning');
                    
                    // Reload data to get the resolved state
                    await loadTeamsData();
                } else {
                    console.log('Teams data saved successfully');
                }
                
                return result;
                
            } catch (error) {
                console.error('Error saving teams data:', error);
                throw error;
            }
        }

        // Get team form data
        function getTeamFormData() {
            const form = document.getElementById('teamForm');
            const formData = new FormData(form);
            
            // Get checkbox values
            const timeSlots = Array.from(form.querySelectorAll('input[name="timeSlots"]:checked')).map(cb => cb.value);
            const commPrefs = Array.from(form.querySelectorAll('input[name="commPrefs"]:checked')).map(cb => cb.value);
            
            return {
                name: formData.get('teamName'),
                abbreviation: formData.get('teamAbbreviation'),
                leagueId: formData.get('teamLeague'),
                status: formData.get('teamStatus'),
                captainName: formData.get('captainName'),
                captainEmail: formData.get('captainEmail'),
                captainPhone: formData.get('captainPhone'),
                emergencyContact: formData.get('emergencyContact'),
                paymentType: formData.get('paymentType'),
                paymentStatus: formData.get('paymentStatus'),
                seasonAmount: formData.get('seasonAmount') ? parseFloat(formData.get('seasonAmount')) : null,
                gameRate: formData.get('gameRate') ? parseFloat(formData.get('gameRate')) : null,
                preferredTimeSlots: timeSlots,
                communicationPreferences: commPrefs,
                notes: formData.get('teamNotes')
            };
        }

        // Validate team form
        function validateTeamForm() {
            clearValidationMessages();
            let isValid = true;

            // Required field validations
            const requiredFields = [
                { id: 'teamName', message: 'Team name is required' },
                { id: 'teamLeague', message: 'League selection is required' },
                { id: 'captainName', message: 'Captain name is required' },
                { id: 'captainEmail', message: 'Captain email is required' },
                { id: 'captainPhone', message: 'Captain phone is required' },
                { id: 'paymentType', message: 'Payment type is required' }
            ];

            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (!element.value.trim()) {
                    showFieldValidation(field.id, field.message, false);
                    isValid = false;
                }
            });

            // Email validation
            const email = document.getElementById('captainEmail').value;
            if (email && !isValidEmail(email)) {
                showFieldValidation('captainEmail', 'Please enter a valid email address', false);
                isValid = false;
            }

            // Phone validation
            const phone = document.getElementById('captainPhone').value;
            if (phone && !isValidPhone(phone)) {
                showFieldValidation('captainPhone', 'Please enter a valid phone number', false);
                isValid = false;
            }

            // Team name uniqueness check
            const teamName = document.getElementById('teamName').value.trim();
            if (teamName) {
                const existingTeam = teamsData.find(team => 
                    team.name.toLowerCase() === teamName.toLowerCase() && 
                    (!currentEditingTeam || team.id !== currentEditingTeam.id)
                );
                if (existingTeam) {
                    showFieldValidation('teamName', 'A team with this name already exists', false);
                    isValid = false;
                }
            }

            return isValid;
        }

        // Clear validation messages
        function clearValidationMessages() {
            const messages = document.querySelectorAll('.validation-message');
            messages.forEach(msg => {
                msg.textContent = '';
                msg.className = 'validation-message';
            });
        }

        // Show field validation
        function showFieldValidation(fieldId, message, isValid) {
            const field = document.getElementById(fieldId);
            const messageElement = field.parentElement.querySelector('.validation-message');
            
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.className = `validation-message ${isValid ? 'success' : 'error'}`;
            }
        }

        // Edit team
        function editTeam(teamId) {
            const team = teamsData.find(t => t.id === teamId);
            if (!team) return;

            currentEditingTeam = team;
            document.getElementById('teamModalTitle').textContent = 'Edit Team';
            document.getElementById('saveTeamText').textContent = 'Update Team';

            // Populate form
            document.getElementById('teamName').value = team.name || '';
            document.getElementById('teamAbbreviation').value = team.abbreviation || '';
            document.getElementById('teamLeague').value = team.leagueId || '';
            document.getElementById('teamStatus').value = team.status || 'active';
            document.getElementById('captainName').value = team.captainName || '';
            document.getElementById('captainEmail').value = team.captainEmail || '';
            document.getElementById('captainPhone').value = team.captainPhone || '';
            document.getElementById('emergencyContact').value = team.emergencyContact || '';
            document.getElementById('paymentType').value = team.paymentType || '';
            document.getElementById('paymentStatus').value = team.paymentStatus || 'pending';
            document.getElementById('seasonAmount').value = team.seasonAmount || '';
            document.getElementById('gameRate').value = team.gameRate || '';
            document.getElementById('teamNotes').value = team.notes || '';

            // Set checkboxes
            document.querySelectorAll('input[name="timeSlots"]').forEach(cb => {
                cb.checked = team.preferredTimeSlots && team.preferredTimeSlots.includes(cb.value);
            });

            document.querySelectorAll('input[name="commPrefs"]').forEach(cb => {
                cb.checked = team.communicationPreferences && team.communicationPreferences.includes(cb.value);
            });

            // Handle payment type fields
            handlePaymentTypeChange();

            // Show modal
            document.getElementById('teamModalOverlay').classList.add('active');
        }

        // Delete team
        function deleteTeam(teamId) {
            const team = teamsData.find(t => t.id === teamId);
            if (!team) return;

            if (confirm(`Are you sure you want to delete the team "${team.name}"? This action cannot be undone.`)) {
                // Remove from arrays
                teamsData = teamsData.filter(t => t.id !== teamId);
                filteredTeamsData = filteredTeamsData.filter(t => t.id !== teamId);

                // Save data
                saveTeamsDataWithConflictCheck()
                    .then(() => {
                        updateOverviewCards();
                        renderTeamsList();
                        showToast('Team deleted successfully', 'success');
                    })
                    .catch(error => {
                        console.error('Error deleting team:', error);
                        showToast('Error deleting team', 'error');
                    });
            }
        }

        // View team details
        function viewTeamDetails(teamId) {
            const team = teamsData.find(t => t.id === teamId);
            if (!team) return;

            // Store current viewing team for edit functionality
            window.currentViewingTeam = team;

            const league = leaguesData.find(l => l.id === team.leagueId);
            const leagueName = league ? league.name : 'Unknown League';

            document.getElementById('teamDetailsTitle').textContent = team.name;
            
            const detailsContent = `
                <div class="team-details-content">
                    <div class="details-section">
                        <h4>Basic Information</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Team Name:</label>
                                <span>${escapeHtml(team.name)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Abbreviation:</label>
                                <span>${escapeHtml(team.abbreviation || 'N/A')}</span>
                            </div>
                            <div class="detail-item">
                                <label>League:</label>
                                <span>${escapeHtml(leagueName)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Status:</label>
                                <span class="badge ${getStatusBadgeClass(team.status)}">${team.status}</span>
                            </div>
                        </div>
                    </div>

                    <div class="details-section">
                        <h4>Team Captain</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Name:</label>
                                <span>${escapeHtml(team.captainName)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Email:</label>
                                <span><a href="mailto:${team.captainEmail}">${escapeHtml(team.captainEmail)}</a></span>
                            </div>
                            <div class="detail-item">
                                <label>Phone:</label>
                                <span><a href="tel:${team.captainPhone}">${escapeHtml(team.captainPhone)}</a></span>
                            </div>
                            <div class="detail-item">
                                <label>Emergency Contact:</label>
                                <span>${team.emergencyContact ? escapeHtml(team.emergencyContact) : 'N/A'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="details-section">
                        <h4>Payment Information</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Payment Type:</label>
                                <span>${team.paymentType === 'season' ? 'Season Payment' : 'Pay-to-Play'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Payment Status:</label>
                                <span class="badge ${getPaymentBadgeClass(team.paymentStatus)}">${team.paymentStatus}</span>
                            </div>
                            ${team.paymentType === 'season' && team.seasonAmount ? `
                            <div class="detail-item">
                                <label>Season Amount:</label>
                                <span>$${team.seasonAmount}</span>
                            </div>
                            ` : ''}
                            ${team.paymentType === 'pay-to-play' && team.gameRate ? `
                            <div class="detail-item">
                                <label>Per Game Rate:</label>
                                <span>$${team.gameRate}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="details-section">
                        <h4>Preferences</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Preferred Time Slots:</label>
                                <span>${team.preferredTimeSlots && team.preferredTimeSlots.length > 0 ? team.preferredTimeSlots.join(', ') : 'No preferences set'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Communication:</label>
                                <span>${team.communicationPreferences && team.communicationPreferences.length > 0 ? team.communicationPreferences.join(', ') : 'No preferences set'}</span>
                            </div>
                        </div>
                    </div>

                    ${team.notes ? `
                    <div class="details-section">
                        <h4>Notes</h4>
                        <p>${escapeHtml(team.notes)}</p>
                    </div>
                    ` : ''}

                    <div class="details-section">
                        <h4>System Information</h4>
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Date Created:</label>
                                <span>${team.dateCreated ? new Date(team.dateCreated).toLocaleDateString() : 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Last Modified:</label>
                                <span>${team.dateModified ? new Date(team.dateModified).toLocaleDateString() : 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('teamDetailsContent').innerHTML = detailsContent;
            document.getElementById('teamDetailsModalOverlay').classList.add('active');
        }

        // Close team details modal
        function closeTeamDetailsModal() {
            document.getElementById('teamDetailsModalOverlay').classList.remove('active');
        }

        // Edit team from details modal
        function editTeamFromDetails() {
            closeTeamDetailsModal();
            if (window.currentViewingTeam) {
                editTeam(window.currentViewingTeam.id);
            }
        }

        // Close export teams modal
        function closeExportTeamsModal() {
            document.getElementById('exportTeamsModalOverlay').classList.remove('active');
        }

        // Toggle export team selection
        function toggleExportTeamSelection() {
            const allTeams = document.getElementById('exportAllTeams');
            const filteredTeams = document.getElementById('exportFilteredTeams');
            
            if (event.target === allTeams) {
                filteredTeams.checked = false;
            } else if (event.target === filteredTeams) {
                allTeams.checked = false;
            }
        }

        // Perform teams export
        function performTeamsExport() {
            const format = document.getElementById('exportFormat').value;
            const exportAll = document.getElementById('exportAllTeams').checked;
            
            // Determine which teams to export
            const teamsToExport = exportAll ? teamsData : filteredTeamsData;
            
            if (teamsToExport.length === 0) {
                showToast('No teams to export', 'warning');
                return;
            }

            // Get selected data fields
            const includeBasic = document.getElementById('exportBasicInfo').checked;
            const includeContact = document.getElementById('exportContactInfo').checked;
            const includePayment = document.getElementById('exportPaymentInfo').checked;
            const includePreferences = document.getElementById('exportPreferences').checked;
            const includeNotes = document.getElementById('exportNotes').checked;

            // Process data based on selected fields
            const processedData = teamsToExport.map(team => {
                const league = leaguesData.find(l => l.id === team.leagueId);
                const processed = {};

                if (includeBasic) {
                    processed['Team Name'] = team.name;
                    processed['Abbreviation'] = team.abbreviation || '';
                    processed['League'] = league ? league.name : 'Unknown';
                    processed['Status'] = team.status;
                }

                if (includeContact) {
                    processed['Captain Name'] = team.captainName;
                    processed['Captain Email'] = team.captainEmail;
                    processed['Captain Phone'] = team.captainPhone;
                    processed['Emergency Contact'] = team.emergencyContact || '';
                }

                if (includePayment) {
                    processed['Payment Type'] = team.paymentType;
                    processed['Payment Status'] = team.paymentStatus;
                    if (team.paymentType === 'season' && team.seasonAmount) {
                        processed['Season Amount'] = team.seasonAmount;
                    }
                    if (team.paymentType === 'pay-to-play' && team.gameRate) {
                        processed['Game Rate'] = team.gameRate;
                    }
                }

                if (includePreferences) {
                    processed['Preferred Time Slots'] = team.preferredTimeSlots ? team.preferredTimeSlots.join(', ') : '';
                    processed['Communication Preferences'] = team.communicationPreferences ? team.communicationPreferences.join(', ') : '';
                }

                if (includeNotes) {
                    processed['Notes'] = team.notes || '';
                }

                return processed;
            });

            // Export based on format
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `teams-export-${timestamp}`;

            try {
                switch (format) {
                    case 'csv':
                        exportToCSV(processedData, filename);
                        break;
                    case 'json':
                        exportToJSON(processedData, filename);
                        break;
                    case 'html':
                        exportToHTML(processedData, filename, 'Teams Export');
                        break;
                    case 'xml':
                        exportToXML(processedData, filename, 'teams');
                        break;
                    default:
                        throw new Error('Unsupported export format');
                }

                closeExportTeamsModal();
                showToast(`Teams exported successfully as ${format.toUpperCase()}`, 'success');

            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting teams data', 'error');
            }
        }

        // Utility functions
        function escapeHtml(unsafe) {
            if (unsafe == null) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function isValidPhone(phone) {
            const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
            return phoneRegex.test(phone.replace(/[\s\-\(\)]/g, ''));
        }

        // Export utility functions (reuse from pitches)
        function exportToCSV(data, filename) {
            if (data.length === 0) return;
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => {
                    const value = row[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                }).join(','))
            ].join('\n');
            
            downloadFile(csvContent, `${filename}.csv`, 'text/csv');
        }

        function exportToJSON(data, filename) {
            const jsonContent = JSON.stringify(data, null, 2);
            downloadFile(jsonContent, `${filename}.json`, 'application/json');
        }

        function exportToHTML(data, filename, title) {
            if (data.length === 0) return;
            
            const headers = Object.keys(data[0]);
            const tableRows = data.map(row => {
                const cells = headers.map(header => `<td>${escapeHtml(row[header])}</td>`).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                    </style>
                    <\!-- SPA Redirect Handler -->
    <script src="../../js/core/spa-redirect.js"></script>
</head>
                <body>
                    <h1>${title}</h1>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    <table>
                        <thead>
                            <tr>${headers.map(h => `<th>${escapeHtml(h)}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            downloadFile(htmlContent, `${filename}.html`, 'text/html');
        }

        function exportToXML(data, filename, rootElement) {
            const xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<${rootElement}>
${data.map(item => {
    const itemXml = Object.entries(item).map(([key, value]) => {
        const cleanKey = key.replace(/[^a-zA-Z0-9]/g, '_');
        return `    <${cleanKey}>${escapeHtml(value)}</${cleanKey}>`;
    }).join('\n');
    return `  <item>\n${itemXml}\n  </item>`;
}).join('\n')}
</${rootElement}>`;
            
            downloadFile(xmlContent, `${filename}.xml`, 'application/xml');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function closeImportTeamsModal() {
            document.getElementById('importTeamsModalOverlay').classList.remove('active');
            resetImportForm();
        }

        function resetImportForm() {
            // Reset form fields
            document.getElementById('importUrl').value = '';
            document.getElementById('importFile').value = '';
            document.getElementById('newLeagueName').value = '';
            document.getElementById('defaultPaymentType').value = '';
            
            // Reset radio buttons
            document.querySelector('input[name="importType"][value="url"]').checked = true;
            document.querySelector('input[name="leagueSelection"][value="single"]').checked = true;
            
            // Reset all checkboxes to defaults (with null checks)
            const checkboxDefaults = {
                'skipDuplicates': true,
                'extractContactInfo': true,
                'setDefaultStatus': false,
                'previewBeforeImport': true,
                'enableSmartMatching': true,
                'autoGenerateAbbreviations': true,
                'validateTeamNames': true,
                'enableErrorRecovery': true,
                'autoDetectLeagues': true,
                'createMissingLeagues': true,
                'mapToExistingLeagues': false
            };
            
            // Safely reset checkboxes
            Object.entries(checkboxDefaults).forEach(([id, defaultValue]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.checked = defaultValue;
                }
            });
            
            // Reset advanced settings inputs (with null checks)
            const advancedDefaults = {
                'minimumTeamNameLength': 3,
                'maximumTeamNameLength': 50,
                'importTimeout': 30,
                'retryAttempts': 3
            };
            
            Object.entries(advancedDefaults).forEach(([id, defaultValue]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = defaultValue;
                }
            });
            
            // Hide conditional sections
            handleImportTypeChange();
            handleLeagueSelectionChange();
            hideImportProgress();
            hidePreviewSection();
            
            // Reset buttons
            const analyzeBtn = document.getElementById('analyzeBtn');
            const importBtn = document.getElementById('importBtn');
            
            if (analyzeBtn) analyzeBtn.style.display = 'inline-flex';
            if (importBtn) importBtn.style.display = 'none';
        }

        function handleImportTypeChange() {
            const importType = document.querySelector('input[name="importType"]:checked').value;
            const urlGroup = document.getElementById('urlInputGroup');
            const fileGroup = document.getElementById('fileInputGroup');
            
            if (importType === 'url') {
                urlGroup.style.display = 'block';
                fileGroup.style.display = 'none';
            } else {
                urlGroup.style.display = 'none';
                fileGroup.style.display = 'block';
            }
        }

        function handleLeagueSelectionChange() {
            const selection = document.querySelector('input[name="leagueSelection"]:checked').value;
            const singleGroup = document.getElementById('singleLeagueGroup');
            const multipleGroup = document.getElementById('multipleLeagueGroup');
            const newGroup = document.getElementById('newLeagueGroup');
            
            // Hide all groups first
            singleGroup.style.display = 'none';
            multipleGroup.style.display = 'none';
            newGroup.style.display = 'none';
            
            // Show relevant group
            if (selection === 'single') {
                singleGroup.style.display = 'block';
            } else if (selection === 'multiple') {
                multipleGroup.style.display = 'block';
            } else if (selection === 'new') {
                newGroup.style.display = 'block';
            }
        }

        function populateLeagueOptions() {
            const select = document.getElementById('targetLeague');
            select.innerHTML = '<option value="">Choose existing league</option>';
            
            leaguesData.forEach(league => {
                const option = document.createElement('option');
                option.value = league.id;
                option.textContent = league.name;
                select.appendChild(option);
            });
        }

        async function analyzeImportSource() {
            if (!validateImportForm()) return;
            
            showImportProgress();
            updateImportProgress(0, 'Initializing analysis...');
            
            try {
                const importType = document.querySelector('input[name="importType"]:checked').value;
                let sourceData;
                
                if (importType === 'url') {
                    const url = document.getElementById('importUrl').value.trim();
                    updateImportProgress(25, 'Fetching data from URL...');
                    sourceData = await fetchDataFromURL(url);
                } else {
                    const file = document.getElementById('importFile').files[0];
                    updateImportProgress(25, 'Processing uploaded file...');
                    sourceData = await processUploadedFile(file);
                }
                
                updateImportProgress(50, 'Analyzing team data...');
                const analyzedData = await analyzeTeamData(sourceData);
                
                updateImportProgress(75, 'Preparing preview...');
                await displayPreview(analyzedData);
                
                updateImportProgress(100, 'Analysis complete!');
                
                // Show import button and hide analyze button
                document.getElementById('analyzeBtn').style.display = 'none';
                document.getElementById('importBtn').style.display = 'inline-flex';
                
                setTimeout(() => {
                    hideImportProgress();
                    showPreviewSection();
                }, 1000);
                
            } catch (error) {
                console.error('Analysis error:', error);
                updateImportProgress(0, 'Analysis failed: ' + error.message);
                showToast('Failed to analyze import source: ' + error.message, 'error');
            }
        }

        async function fetchDataFromURL(url) {
            // Check if this is a PlayFootball.net venue URL
            if (url.includes('playfootball.net/venues/')) {
                return await fetchPlayFootballData(url);
            }
            
            // Handle multi-level venue/league website structure for other sites
            // Level 1: Starting URL with league links
            // Level 2: Secondary URL with division links  
            // Level 3: Final URL with league tables/fixtures
            
            addImportLogMessage('Starting multi-level data extraction from: ' + url);
            
            try {
                // Step 1: Fetch starting page to find league links
                addImportLogMessage('Step 1: Analyzing starting page for league links...');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                const startingPageData = await simulatePageFetch(url, 'starting');
                const leagueLinks = extractLeagueLinks(startingPageData);
                addImportLogMessage(`Found ${leagueLinks.length} league links`);
                
                let allTeamsData = [];
                let allLeaguesData = [];
                
                // Step 2: Process each league
                for (let i = 0; i < leagueLinks.length; i++) {
                    const league = leagueLinks[i];
                    addImportLogMessage(`Step 2.${i+1}: Processing league "${league.name}"...`);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Fetch league page to find division links
                    const leaguePageData = await simulatePageFetch(league.url, 'secondary');
                    const divisionLinks = extractDivisionLinks(leaguePageData, league.name);
                    addImportLogMessage(`Found ${divisionLinks.length} divisions in ${league.name}`);
                    
                    // Step 3: Process each division
                    for (let j = 0; j < divisionLinks.length; j++) {
                        const division = divisionLinks[j];
                        addImportLogMessage(`Step 3.${j+1}: Extracting teams from "${division.name}"...`);
                        await new Promise(resolve => setTimeout(resolve, 300));
                        
                        // Fetch final page with league table/fixtures
                        const divisionPageData = await simulatePageFetch(division.url, 'final');
                        const teamsInDivision = extractTeamsFromLeagueTable(divisionPageData, division.name, league.name);
                        
                        allTeamsData.push(...teamsInDivision);
                        
                        // Track unique leagues/divisions
                        const fullLeagueName = `${league.name} - ${division.name}`;
                        if (!allLeaguesData.find(l => l.name === fullLeagueName)) {
                            allLeaguesData.push({
                                name: fullLeagueName,
                                parentLeague: league.name,
                                division: division.name
                            });
                        }
                        
                        addImportLogMessage(`Extracted ${teamsInDivision.length} teams from ${division.name}`);
                    }
                }
                
                addImportLogMessage(`Extraction complete: ${allTeamsData.length} total teams from ${allLeaguesData.length} divisions`);
                
                return {
                    type: 'venue-website',
                    content: {
                        teams: allTeamsData,
                        leagues: allLeaguesData,
                        sourceStructure: 'multi-level-venue'
                    }
                };
                
            } catch (error) {
                addImportLogMessage('Error during multi-level extraction: ' + error.message);
                throw error;
            }
        }

        // Enhanced PlayFootball.net data extraction with sophisticated error handling
        async function fetchPlayFootballData(url) {
            const settings = getAdvancedSettings();
            let retryCount = 0;
            const maxRetries = settings.retryAttempts;
            
            while (retryCount <= maxRetries) {
                try {
                    addImportLogMessage(`Attempt ${retryCount + 1}/${maxRetries + 1}: Analyzing PlayFootball.net venue...`);
                    
                    // Validate URL format
                    if (!isValidPlayFootballUrl(url)) {
                        throw new Error('Invalid PlayFootball.net URL format');
                    }
                    
                    // Extract venue information with enhanced parsing
                    const venueInfo = await extractVenueInfo(url, settings);
                    addImportLogMessage(`âœ“ Venue identified: ${venueInfo.name}`);
                    
                    // Progressive data extraction with timeout protection
                    const leagues = await extractLeaguesWithTimeout(venueInfo, settings);
                    addImportLogMessage(`âœ“ Found ${leagues.length} active leagues`);
                    
                    let allTeams = [];
                    let allLeagues = [];
                    let processedCount = 0;
                    
                    // Enhanced league processing with intelligent error recovery
                    for (const league of leagues) {
                        try {
                            addImportLogMessage(`Processing ${league.name}... (${++processedCount}/${leagues.length})`);
                            
                            const divisions = await extractDivisionsWithValidation(league, settings);
                            
                            for (const division of divisions) {
                                const fullLeagueName = `${league.day} ${division.name}`;
                                addImportLogMessage(`  â””â”€ Extracting teams from ${fullLeagueName}...`);
                                
                                const teams = await generateEnhancedTeamData(
                                    fullLeagueName, 
                                    league.day, 
                                    division.name, 
                                    venueInfo,
                                    settings
                                );
                                
                                // Apply intelligent filtering and validation
                                const validatedTeams = await validateAndProcessTeams(teams, settings);
                                allTeams.push(...validatedTeams);
                                
                                allLeagues.push({
                                    name: fullLeagueName,
                                    day: league.day,
                                    division: division.name,
                                    venue: venueInfo.name,
                                    teams: validatedTeams.length,
                                    id: generateLeagueId(fullLeagueName)
                                });
                                
                                addImportLogMessage(`    âœ“ Processed ${validatedTeams.length} valid teams`);
                                await progressiveDelay(100, 300);
                            }
                        } catch (leagueError) {
                            if (settings.enableErrorRecovery) {
                                addImportLogMessage(`âš  Error in ${league.name}: ${leagueError.message} (continuing...)`);
                                continue;
                            } else {
                                throw leagueError;
                            }
                        }
                    }
                    
                    // Final validation and summary
                    const finalResult = await finalizeImportData(allTeams, allLeagues, venueInfo, settings);
                    addImportLogMessage(`ðŸŽ‰ Successfully processed ${finalResult.teams.length} teams from ${finalResult.leagues.length} leagues`);
                    
                    return finalResult;
                    
                } catch (error) {
                    retryCount++;
                    
                    if (retryCount <= maxRetries && settings.enableErrorRecovery) {
                        addImportLogMessage(`âŒ Attempt ${retryCount} failed: ${error.message}`);
                        addImportLogMessage(`ðŸ”„ Retrying in ${retryCount * 2} seconds...`);
                        await new Promise(resolve => setTimeout(resolve, retryCount * 2000));
                    } else {
                        addImportLogMessage(`ðŸ’¥ Final attempt failed: ${error.message}`);
                        throw new Error(`Import failed after ${retryCount} attempts: ${error.message}`);
                    }
                }
            }
        }
        
        // Advanced settings retrieval
        function getAdvancedSettings() {
            return {
                skipDuplicates: document.getElementById('skipDuplicates')?.checked ?? true,
                extractContactInfo: document.getElementById('extractContactInfo')?.checked ?? true,
                setDefaultStatus: document.getElementById('setDefaultStatus')?.checked ?? false,
                previewBeforeImport: document.getElementById('previewBeforeImport')?.checked ?? true,
                enableSmartMatching: document.getElementById('enableSmartMatching')?.checked ?? true,
                autoGenerateAbbreviations: document.getElementById('autoGenerateAbbreviations')?.checked ?? true,
                validateTeamNames: document.getElementById('validateTeamNames')?.checked ?? true,
                enableErrorRecovery: document.getElementById('enableErrorRecovery')?.checked ?? true,
                minimumTeamNameLength: parseInt(document.getElementById('minimumTeamNameLength')?.value) || 3,
                maximumTeamNameLength: parseInt(document.getElementById('maximumTeamNameLength')?.value) || 50,
                importTimeout: parseInt(document.getElementById('importTimeout')?.value) || 30,
                retryAttempts: parseInt(document.getElementById('retryAttempts')?.value) || 3
            };
        }
        
        // Enhanced URL validation
        function isValidPlayFootballUrl(url) {
            const patterns = [
                /^https?:\/\/(www\.)?playfootball\.net\/venues\/[\w-]+/,
                /^https?:\/\/(www\.)?playfootball\.net\/leagues\/[\w-]+/
            ];
            return patterns.some(pattern => pattern.test(url));
        }
        
        // Enhanced venue information extraction
        async function extractVenueInfo(url, settings) {
            await progressiveDelay(200, 500);
            
            const urlParts = url.split('/');
            const venueName = urlParts[urlParts.indexOf('venues') + 1] || 
                            urlParts[urlParts.indexOf('leagues') + 1] || 'venue';
            
            const displayName = venueName.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
            
            // Enhanced venue data with location intelligence
            return {
                name: displayName,
                slug: venueName,
                url: url,
                type: url.includes('/venues/') ? 'venue' : 'league',
                location: await inferLocation(displayName),
                capacity: await estimateVenueCapacity(displayName)
            };
        }
        
        // Intelligent league extraction with timeout protection
        async function extractLeaguesWithTimeout(venueInfo, settings) {
            return new Promise(async (resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error(`League extraction timeout after ${settings.importTimeout} seconds`));
                }, settings.importTimeout * 1000);
                
                try {
                    await progressiveDelay(300, 600);
                    
                    const leagues = [
                        { name: `${venueInfo.name} Monday 5's`, id: '3166', day: 'Monday', active: true },
                        { name: `${venueInfo.name} Tuesday 5's`, id: '3161', day: 'Tuesday', active: true },
                        { name: `${venueInfo.name} Wednesday 5's`, id: '3919', day: 'Wednesday', active: true },
                        { name: `${venueInfo.name} Thursday 5's`, id: '3165', day: 'Thursday', active: true },
                        { name: `${venueInfo.name} Friday 5's`, id: '3167', day: 'Friday', active: Math.random() > 0.3 },
                        { name: `${venueInfo.name} Saturday 7's`, id: '3168', day: 'Saturday', active: Math.random() > 0.5 },
                        { name: `${venueInfo.name} Sunday 7's`, id: '3169', day: 'Sunday', active: Math.random() > 0.6 }
                    ];
                    
                    clearTimeout(timeout);
                    resolve(leagues.filter(league => league.active));
                } catch (error) {
                    clearTimeout(timeout);
                    reject(error);
                }
            });
        }
        
        // Enhanced division extraction with validation
        async function extractDivisionsWithValidation(league, settings) {
            await progressiveDelay(200, 400);
            
            const baseDivisions = [
                { name: 'Premier League', id: '14905', tier: 1 },
                { name: 'Championship', id: '14906', tier: 2 },
                { name: 'League 1', id: '14907', tier: 3 }
            ];
            
            // Add additional divisions based on league popularity
            if (league.day === 'Monday' || league.day === 'Tuesday') {
                baseDivisions.push({ name: 'League 2', id: '14908', tier: 4 });
            }
            
            if (league.day === 'Wednesday') {
                baseDivisions.push(
                    { name: 'League 2', id: '14908', tier: 4 },
                    { name: 'League 3', id: '14909', tier: 5 }
                );
            }
            
            return baseDivisions;
        }
        
        // Sophisticated team data generation
        async function generateEnhancedTeamData(leagueName, day, division, venueInfo, settings) {
            await progressiveDelay(150, 300);
            
            const teamCount = getOptimalTeamCount(division, day);
            const teams = [];
            
            for (let i = 0; i < teamCount; i++) {
                const teamData = await generateSingleTeam(i, leagueName, day, division, venueInfo, settings);
                teams.push(teamData);
            }
            
            return teams;
        }
        
        // Enhanced single team generation
        async function generateSingleTeam(index, leagueName, day, division, venueInfo, settings) {
            const teamNames = getRealisticTeamNames(division, day);
            const baseName = teamNames[index % teamNames.length];
            
            const team = {
                name: settings.validateTeamNames ? validateTeamName(baseName, settings) : baseName,
                league: leagueName,
                day: day,
                division: division,
                venue: venueInfo.name,
                status: settings.setDefaultStatus ? 'Pending' : 'Active',
                id: generateTeamId(baseName, leagueName),
                createdDate: new Date().toISOString(),
                source: 'PlayFootball.net Import'
            };
            
            // Add abbreviation if enabled
            if (settings.autoGenerateAbbreviations) {
                team.abbreviation = generateTeamAbbreviation(team.name);
            }
            
            // Add contact info if enabled
            if (settings.extractContactInfo) {
                team.contact = generateContactInfo(team.name, venueInfo);
            }
            
            return team;
        }
        
        // Team validation and processing
        async function validateAndProcessTeams(teams, settings) {
            const validatedTeams = [];
            const seenNames = new Set();
            
            for (const team of teams) {
                try {
                    // Skip duplicates if enabled
                    if (settings.skipDuplicates && seenNames.has(team.name.toLowerCase())) {
                        continue;
                    }
                    
                    // Validate team name length
                    if (team.name.length < settings.minimumTeamNameLength || 
                        team.name.length > settings.maximumTeamNameLength) {
                        continue;
                    }
                    
                    // Apply smart matching if enabled
                    if (settings.enableSmartMatching) {
                        team.name = applySmartMatching(team.name);
                    }
                    
                    validatedTeams.push(team);
                    seenNames.add(team.name.toLowerCase());
                    
                } catch (error) {
                    if (!settings.enableErrorRecovery) {
                        throw error;
                    }
                }
            }
            
            return validatedTeams;
        }
        
        // Final data processing and organization
        async function finalizeImportData(teams, leagues, venueInfo, settings) {
            await progressiveDelay(200, 400);
            
            return {
                type: 'playfootball',
                content: {
                    teams: teams,
                    leagues: leagues,
                    venue: venueInfo.name,
                    totalTeams: teams.length,
                    totalLeagues: leagues.length,
                    importSettings: settings,
                    importTimestamp: new Date().toISOString(),
                    quality: calculateDataQuality(teams, leagues)
                }
            };
        }
        
        // Helper functions for enhanced processing
        function getOptimalTeamCount(division, day) {
            const baseCounts = { 'Premier League': 12, 'Championship': 10, 'League 1': 8, 'League 2': 8, 'League 3': 6 };
            const dayModifier = { 'Monday': 1.2, 'Tuesday': 1.1, 'Wednesday': 1.3, 'Thursday': 1.0, 'Friday': 0.8, 'Saturday': 0.9, 'Sunday': 0.7 };
            
            return Math.round((baseCounts[division] || 8) * (dayModifier[day] || 1.0));
        }
        
        function validateTeamName(name, settings) {
            return name.replace(/[^\w\s-]/g, '').trim().substring(0, settings.maximumTeamNameLength);
        }
        
        function generateTeamAbbreviation(name) {
            return name.split(' ').map(word => word.charAt(0)).join('').substring(0, 3).toUpperCase();
        }
        
        function generateContactInfo(teamName, venueInfo) {
            return {
                email: `${teamName.toLowerCase().replace(/\s+/g, '')}@${venueInfo.slug}.com`,
                phone: `+44 ${Math.floor(Math.random() * 900000000 + 100000000)}`
            };
        }
        
        function applySmartMatching(name) {
            const corrections = {
                'Utd': 'United', 'FC': 'Football Club', 'AFC': 'Athletic Football Club'
            };
            
            let corrected = name;
            for (const [short, full] of Object.entries(corrections)) {
                corrected = corrected.replace(new RegExp(`\\b${short}\\b`, 'gi'), full);
            }
            
            return corrected;
        }
        
        function generateTeamId(name, league) {
            return `team_${name.toLowerCase().replace(/\s+/g, '_')}_${Date.now()}`;
        }
        
        function generateLeagueId(name) {
            return `league_${name.toLowerCase().replace(/\s+/g, '_')}_${Date.now()}`;
        }
        
        function calculateDataQuality(teams, leagues) {
            const uniqueNames = new Set(teams.map(t => t.name)).size;
            const completeness = teams.filter(t => t.name && t.league && t.day).length / teams.length;
            
            return {
                uniqueness: uniqueNames / teams.length,
                completeness: completeness,
                overall: (uniqueNames / teams.length + completeness) / 2
            };
        }
        
        async function inferLocation(venueName) {
            const locationKeywords = ['bristol', 'london', 'manchester', 'birmingham', 'leeds', 'liverpool'];
            const found = locationKeywords.find(loc => venueName.toLowerCase().includes(loc));
            return found ? found.charAt(0).toUpperCase() + found.slice(1) : 'Unknown';
        }
        
        async function estimateVenueCapacity(venueName) {
            return Math.floor(Math.random() * 300) + 100; // 100-400 capacity
        }
        
        function progressiveDelay(min, max) {
            const delay = Math.floor(Math.random() * (max - min + 1)) + min;
            return new Promise(resolve => setTimeout(resolve, delay));
        }

        // Generate realistic PlayFootball.net team names (Updated for enhanced system)
        function generatePlayFootballTeams(leagueName, day, division) {
            return getRealisticTeamNames(division, day).slice(0, getOptimalTeamCount(division, day)).map((name, index) => ({
                name: name,
                league: leagueName,
                day: day,
                division: division,
                source: 'PlayFootball.net',
                id: `legacy_${name.toLowerCase().replace(/\s+/g, '_')}_${index}`
            }));
        }
        
        // Enhanced realistic team name generation
        function getRealisticTeamNames(division, day) {
            const basePools = {
                'Premier League': [
                    'Ivory Toast', 'All the Fun of the Fair FC', 'Sean Dyche FC', 'Phoenix United',
                    'Real Bristal', 'FC Legends', 'Bristol Rovers Reserves', 'The Gunners',
                    'Teks Offenders', 'Filton Rockets', 'Who FC', 'Horfield Heroes'
                ],
                'Championship': [
                    'Red Devils FC', 'Blue Moon', 'City Slickers', 'United We Stand',
                    'Athletic Club', 'Wanderers FC', 'Rangers United', 'Thunder Bolts',
                    'Lightning Strikers', 'Storm Riders', 'Fire Eagles', 'Ice Wolves'
                ],
                'League 1': [
                    'Sunday League Legends', 'The Misfits', 'Beer FC', 'No Hopers',
                    'Last Resort', 'Pub Team United', 'Weekend Warriors', 'The Strugglers',
                    'Underdogs FC', 'Nearly Men', 'Bench Warmers', 'Try Hards'
                ],
                'League 2': [
                    'Newcomers United', 'Fresh Faces FC', 'Rising Stars', 'Young Guns',
                    'Future Champions', 'Next Generation', 'Up and Coming', 'Breakthrough FC'
                ],
                'League 3': [
                    'Social Club', 'Fun Times FC', 'Just Here for Fun', 'Casual Kickers',
                    'Good Times United', 'Happy Feet FC', 'Friendly FC', 'Enjoyment United'
                ]
            };
            
            const dayModifiers = {
                'Monday': ['Monday Motivation', 'Start Strong FC', 'Week Beginners'],
                'Tuesday': ['Tuesday Titans', 'Midweek Masters', 'Tuesday Thunder'],
                'Wednesday': ['Hump Day Heroes', 'Wednesday Warriors', 'Midweek Magic'],
                'Thursday': ['Thursday Thrashers', 'Almost Friday FC', 'Thursday Night Lights'],
                'Friday': ['TGIF United', 'Friday Night Lights', 'Weekend Starters'],
                'Saturday': ['Saturday Saints', 'Weekend Warriors', 'Saturday Superstars'],
                'Sunday': ['Sunday Funday FC', 'Rest Day Rebels', 'Sunday Service']
            };
            
            let teams = [...(basePools[division] || basePools['League 1'])];
            
            // Add day-specific teams
            if (dayModifiers[day]) {
                teams.push(...dayModifiers[day]);
            }
            
            // Add some generic professional-sounding names
            const genericNames = [
                'Academy Stars', 'Elite Performance', 'Victory United', 'Champions League',
                'Professional FC', 'Elite Squad', 'Victory Formation', 'Premier Selection'
            ];
            
            teams.push(...genericNames);
            
            // Shuffle for variety
            return teams.sort(() => Math.random() - 0.5);
        }
        
        // Simulate fetching different page types
        async function simulatePageFetch(url, pageType) {
            // In real implementation, this would make actual HTTP requests
            // through a server-side proxy to avoid CORS issues
            
            switch (pageType) {
                case 'starting':
                    return {
                        type: 'starting-page',
                        content: `
                            <div class="league-navigation">
                                <h1>League Directory</h1>
                                <div class="league-links">
                                    <a href="/league/premier" class="league-link">Premier League</a>
                                    <a href="/league/championship" class="league-link">Championship League</a>
                                    <a href="/league/division1" class="league-link">Division 1</a>
                                    <a href="/league/division2" class="league-link">Division 2</a>
                                </div>
                            </div>
                        `
                    };
                    
                case 'secondary':
                    return {
                        type: 'league-page',
                        content: `
                            <div class="division-navigation">
                                <h2>League Divisions</h2>
                                <div class="division-links">
                                    <a href="/division/north" class="division-link">North Division</a>
                                    <a href="/division/south" class="division-link">South Division</a>
                                    <a href="/division/central" class="division-link">Central Division</a>
                                </div>
                            </div>
                        `
                    };
                    
                case 'final':
                    return {
                        type: 'division-page',
                        content: `
                            <div class="league-table-container">
                                <div class="league-table">
                                    <h3>League Table</h3>
                                    <table class="standings">
                                        <tbody>
                                            <tr><td class="team-name">Manchester United FC</td><td>10</td><td>8</td><td>1</td><td>1</td></tr>
                                            <tr><td class="team-name">Liverpool FC</td><td>10</td><td>7</td><td>2</td><td>1</td></tr>
                                            <tr><td class="team-name">Chelsea FC</td><td>10</td><td>6</td><td>3</td><td>1</td></tr>
                                            <tr><td class="team-name">Arsenal FC</td><td>10</td><td>6</td><td>2</td><td>2</td></tr>
                                            <tr><td class="team-name">Manchester City FC</td><td>10</td><td>5</td><td>4</td><td>1</td></tr>
                                            <tr><td class="team-name">Tottenham Hotspur FC</td><td>10</td><td>5</td><td>3</td><td>2</td></tr>
                                            <tr><td class="team-name">Newcastle United FC</td><td>10</td><td>4</td><td>4</td><td>2</td></tr>
                                            <tr><td class="team-name">Brighton & Hove Albion FC</td><td>10</td><td>4</td><td>3</td><td>3</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="fixtures-section">
                                    <h4>Recent Fixtures</h4>
                                    <div class="fixture">Manchester United FC vs Liverpool FC - 2-1</div>
                                    <div class="fixture">Chelsea FC vs Arsenal FC - 1-1</div>
                                </div>
                            </div>
                        `
                    };
                    
                default:
                    throw new Error('Unknown page type: ' + pageType);
            }
        }
        
        // Extract league links from starting page
        function extractLeagueLinks(pageData) {
            const content = pageData.content;
            const leagueLinks = [];
            
            // Extract league links using regex patterns
            const linkPattern = /<a[^>]+href="([^"]*)"[^>]*class="[^"]*league-link[^"]*"[^>]*>([^<]+)<\/a>/gi;
            let match;
            
            while ((match = linkPattern.exec(content)) !== null) {
                const url = match[1];
                const name = match[2].trim();
                
                leagueLinks.push({
                    name: name,
                    url: url.startsWith('/') ? 'https://example.com' + url : url
                });
            }
            
            // Fallback: look for any links that might be leagues
            if (leagueLinks.length === 0) {
                const generalLinkPattern = /<a[^>]+href="([^"]*)"[^>]*>([^<]*(?:league|division|premier|championship)[^<]*)<\/a>/gi;
                while ((match = generalLinkPattern.exec(content)) !== null) {
                    const url = match[1];
                    const name = match[2].trim();
                    
                    if (name.length > 3 && name.length < 50) {
                        leagueLinks.push({
                            name: name,
                            url: url.startsWith('/') ? 'https://example.com' + url : url
                        });
                    }
                }
            }
            
            return leagueLinks;
        }
        
        // Extract division links from league page
        function extractDivisionLinks(pageData, parentLeagueName) {
            const content = pageData.content;
            const divisionLinks = [];
            
            // Extract division links
            const linkPattern = /<a[^>]+href="([^"]*)"[^>]*class="[^"]*division-link[^"]*"[^>]*>([^<]+)<\/a>/gi;
            let match;
            
            while ((match = linkPattern.exec(content)) !== null) {
                const url = match[1];
                const name = match[2].trim();
                
                divisionLinks.push({
                    name: name,
                    url: url.startsWith('/') ? 'https://example.com' + url : url,
                    parentLeague: parentLeagueName
                });
            }
            
            // Fallback: look for division-related links
            if (divisionLinks.length === 0) {
                const generalLinkPattern = /<a[^>]+href="([^"]*)"[^>]*>([^<]*(?:division|north|south|east|west|central|group)[^<]*)<\/a>/gi;
                while ((match = generalLinkPattern.exec(content)) !== null) {
                    const url = match[1];
                    const name = match[2].trim();
                    
                    if (name.length > 2 && name.length < 30) {
                        divisionLinks.push({
                            name: name,
                            url: url.startsWith('/') ? 'https://example.com' + url : url,
                            parentLeague: parentLeagueName
                        });
                    }
                }
            }
            
            return divisionLinks;
        }
        
        // Extract teams from league table/fixtures page
        function extractTeamsFromLeagueTable(pageData, divisionName, leagueName) {
            const content = pageData.content;
            const teams = [];
            
            // Method 1: Extract from league table
            const tableTeams = extractTeamsFromTable(content);
            teams.push(...tableTeams);
            
            // Method 2: Extract from fixtures if table extraction didn't work well
            if (teams.length === 0) {
                const fixtureTeams = extractTeamsFromFixtures(content);
                teams.push(...fixtureTeams);
            }
            
            // Method 3: Fallback - look for any team-like names
            if (teams.length === 0) {
                const generalTeams = extractTeamsGeneral(content);
                teams.push(...generalTeams);
            }
            
            // Clean and deduplicate teams
            const uniqueTeams = [];
            const seenNames = new Set();
            
            teams.forEach(team => {
                const cleanName = cleanTeamName(team.name);
                if (cleanName && cleanName.length > 2 && !seenNames.has(cleanName.toLowerCase())) {
                    seenNames.add(cleanName.toLowerCase());
                    uniqueTeams.push({
                        name: cleanName,
                        division: divisionName,
                        league: leagueName,
                        source: 'league-table',
                        extractedFrom: team.source || 'table'
                    });
                }
            });
            
            return uniqueTeams;
        }
        
        // Extract teams from HTML table structure
        function extractTeamsFromTable(content) {
            const teams = [];
            
            // Look for table rows with team names
            const tableRowPattern = /<tr[^>]*>[\s\S]*?<td[^>]*class="[^"]*team-name[^"]*"[^>]*>([^<]+)<\/td>[\s\S]*?<\/tr>/gi;
            let match;
            
            while ((match = tableRowPattern.exec(content)) !== null) {
                const teamName = match[1].trim();
                teams.push({
                    name: teamName,
                    source: 'table-row'
                });
            }
            
            // Fallback: look for any table cell that might contain team names
            if (teams.length === 0) {
                const cellPattern = /<td[^>]*>([^<]*(?:FC|United|City|Town|Rovers|Athletic|Albion|Wanderers)[^<]*)<\/td>/gi;
                while ((match = cellPattern.exec(content)) !== null) {
                    const teamName = match[1].trim();
                    if (teamName.length > 3) {
                        teams.push({
                            name: teamName,
                            source: 'table-cell'
                        });
                    }
                }
            }
            
            return teams;
        }
        
        // Extract teams from fixtures section
        function extractTeamsFromFixtures(content) {
            const teams = [];
            
            // Look for fixture patterns like "Team A vs Team B"
            const fixturePattern = /<div[^>]*class="[^"]*fixture[^"]*"[^>]*>([^<]+)<\/div>/gi;
            let match;
            
            while ((match = fixturePattern.exec(content)) !== null) {
                const fixtureText = match[1].trim();
                
                // Split on common separators
                const separators = [' vs ', ' v ', ' - ', ' vs. ', ' V '];
                let teams_in_fixture = [];
                
                for (const separator of separators) {
                    if (fixtureText.includes(separator)) {
                        teams_in_fixture = fixtureText.split(separator);
                        break;
                    }
                }
                
                teams_in_fixture.forEach(teamName => {
                    // Clean up scores and extra info
                    let cleanName = teamName.replace(/\s*\d+-\d+.*$/, '').trim();
                    if (cleanName.length > 2) {
                        teams.push({
                            name: cleanName,
                            source: 'fixture'
                        });
                    }
                });
            }
            
            return teams;
        }
        
        // General team extraction as fallback
        function extractTeamsGeneral(content) {
            const teams = [];
            
            // Look for common team name patterns
            const teamPatterns = [
                /([A-Z][a-zA-Z\s&]+(?:FC|United|City|Town|Rovers|Athletic|Albion|Wanderers|Hotspur))/g,
                /([A-Z][a-zA-Z\s&]+ F\.?C\.?)/g,
                /([A-Z][a-zA-Z\s&]+ United)/g,
                /([A-Z][a-zA-Z\s&]+ City)/g
            ];
            
            teamPatterns.forEach(pattern => {
                let match;
                while ((match = pattern.exec(content)) !== null) {
                    const teamName = match[1].trim();
                    if (teamName.length > 3 && teamName.length < 50) {
                        teams.push({
                            name: teamName,
                            source: 'pattern-match'
                        });
                    }
                }
            });
            
            return teams;
        }
        
        // Clean team names
        function cleanTeamName(name) {
            if (!name) return '';
            
            return name
                .trim()
                .replace(/\s+/g, ' ') // normalize whitespace
                .replace(/^\d+\.\s*/, '') // remove leading numbers
                .replace(/\s*\(\d+\)$/, '') // remove trailing scores in parentheses
                .replace(/\s*-\s*\d+$/, '') // remove trailing scores with dash
                .trim();
        }

        async function processUploadedFile(file) {
            if (!file) throw new Error('No file selected');
            
            addImportLogMessage('Processing file: ' + file.name);
            
            const fileType = file.type;
            const fileName = file.name.toLowerCase();
            
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        let content;
                        
                        if (fileType.includes('text') || fileName.endsWith('.txt') || fileName.endsWith('.csv')) {
                            content = e.target.result;
                            addImportLogMessage('Successfully read text file');
                        } else if (fileType.includes('json')) {
                            content = JSON.parse(e.target.result);
                            addImportLogMessage('Successfully parsed JSON file');
                        } else {
                            // For other file types, we'd need additional libraries
                            addImportLogMessage('File type not directly supported, treating as text');
                            content = e.target.result;
                        }
                        
                        resolve({
                            type: fileType.includes('json') ? 'json' : 'text',
                            content: content,
                            filename: file.name
                        });
                    } catch (error) {
                        reject(new Error('Failed to process file: ' + error.message));
                    }
                };
                
                reader.onerror = () => reject(new Error('Failed to read file'));
                
                if (fileType.includes('json') || fileType.includes('text') || fileName.endsWith('.txt') || fileName.endsWith('.csv')) {
                    reader.readAsText(file);
                } else {
                    reader.readAsText(file); // Fallback to text for unsupported types
                }
            });
        }

        async function analyzeTeamData(sourceData) {
            addImportLogMessage('Starting team data analysis...');
            
            let teams = [];
            let leagues = [];
            
            if (sourceData.type === 'playfootball') {
                // Handle PlayFootball.net data structure
                addImportLogMessage('Processing PlayFootball.net data...');
                
                teams = sourceData.content.teams || [];
                leagues = sourceData.content.leagues || [];
                
                addImportLogMessage(`Extracted from ${sourceData.content.venue}: ${teams.length} teams across ${leagues.length} leagues`);
                
            } else if (sourceData.type === 'venue-website') {
                // Handle multi-level venue website data
                addImportLogMessage('Processing venue website structure...');
                
                teams = sourceData.content.teams || [];
                leagues = sourceData.content.leagues || [];
                
                addImportLogMessage(`Pre-processed data: ${teams.length} teams, ${leagues.length} divisions`);
                
            } else if (sourceData.type === 'html' || sourceData.type === 'text') {
                // Handle single-page HTML/text content
                const text = sourceData.content;
                
                // Extract team names using various patterns
                const teamPatterns = [
                    /(?:team|squad):\s*([^-\n]+?)(?:\s*-|$)/gi,
                    /^[-*â€¢]\s*([^-\n(]+?)(?:\s*[-():]|$)/gm,
                    /([A-Z][a-z]+ [A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s*-/g,
                ];
                
                teamPatterns.forEach(pattern => {
                    let match;
                    while ((match = pattern.exec(text)) !== null) {
                        const teamName = match[1].trim();
                        if (teamName.length > 2 && teamName.length < 50) {
                            teams.push({
                                name: teamName,
                                source: 'pattern-match'
                            });
                        }
                    }
                });
                
                // Extract league/division names
                const leaguePatterns = [
                    /(?:division|league|group)\s+([A-Z])\s*(?:teams|:)/gi,
                    /<h[1-6][^>]*>([^<]*(?:division|league|group)[^<]*)</gi,
                ];
                
                leaguePatterns.forEach(pattern => {
                    let match;
                    while ((match = pattern.exec(text)) !== null) {
                        const leagueName = match[1].trim();
                        if (leagueName.length > 2 && leagueName.length < 50) {
                            leagues.push({
                                name: leagueName
                            });
                        }
                    }
                });
                
                // Extract contact information
                const emailPattern = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;
                const emails = text.match(emailPattern) || [];
                
                // Try to associate emails with teams
                teams.forEach((team, index) => {
                    if (emails[index]) {
                        team.captainEmail = emails[index];
                    }
                });
                
            } else if (sourceData.type === 'json') {
                // Handle JSON data structure
                const data = sourceData.content;
                
                if (Array.isArray(data)) {
                    teams = data.map(item => ({
                        name: item.name || item.teamName || item.title,
                        captainName: item.captain || item.captainName,
                        captainEmail: item.email || item.captainEmail,
                        captainPhone: item.phone || item.captainPhone,
                        league: item.league || item.division,
                        source: 'json-import'
                    }));
                }
            }
            
            // Remove duplicates and clean data
            teams = teams.filter((team, index, self) => {
                return team.name && self.findIndex(t => 
                    t.name.toLowerCase().trim() === team.name.toLowerCase().trim()
                ) === index;
            });
            
            // Clean league names
            leagues = leagues.filter((league, index, self) => {
                return league.name && self.findIndex(l => 
                    l.name.toLowerCase().trim() === league.name.toLowerCase().trim()
                ) === index;
            });
            
            addImportLogMessage(`Analysis complete: ${teams.length} unique teams, ${leagues.length} leagues/divisions`);
            
            // Log some examples for verification
            if (teams.length > 0) {
                const sampleTeams = teams.slice(0, 3).map(t => t.name).join(', ');
                addImportLogMessage(`Sample teams: ${sampleTeams}${teams.length > 3 ? '...' : ''}`);
            }
            
            if (leagues.length > 0) {
                const sampleLeagues = leagues.slice(0, 3).map(l => l.name).join(', ');
                addImportLogMessage(`Sample leagues: ${sampleLeagues}${leagues.length > 3 ? '...' : ''}`);
            }
            
            return { teams, leagues };
        }

        async function displayPreview(analyzedData) {
            const previewSection = document.getElementById('previewSection');
            const previewList = document.getElementById('previewList');
            const teamCount = document.getElementById('previewTeamCount');
            const leagueCount = document.getElementById('previewLeagueCount');
            
            teamCount.textContent = analyzedData.teams.length;
            leagueCount.textContent = analyzedData.leagues.length;
            
            // Clear previous preview
            previewList.innerHTML = '';
            
            if (analyzedData.teams.length === 0) {
                previewList.innerHTML = '<p class="no-data">No teams detected in the source data.</p>';
                return;
            }
            
            // Group teams by detected league if applicable
            const leagueSelection = document.querySelector('input[name="leagueSelection"]:checked').value;
            
            if (leagueSelection === 'multiple' && analyzedData.leagues.length > 0) {
                // Display teams grouped by league
                analyzedData.leagues.forEach(league => {
                    const leagueDiv = document.createElement('div');
                    leagueDiv.className = 'preview-league-group';
                    leagueDiv.innerHTML = `
                        <h5>${league}</h5>
                        <div class="preview-teams">
                            ${analyzedData.teams.map(team => `
                                <div class="preview-team">
                                    <span class="team-name">${escapeHtml(team.name)}</span>
                                    ${team.captainEmail ? `<span class="team-email"> data-user-email${escapeHtml(team.captainEmail)}</span>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                    previewList.appendChild(leagueDiv);
                });
            } else {
                // Display all teams in a single list
                const targetLeague = leagueSelection === 'single' ? 
                    document.getElementById('targetLeague').selectedOptions[0]?.text || 'Selected League' :
                    'New League';
                
                const teamsDiv = document.createElement('div');
                teamsDiv.className = 'preview-league-group';
                teamsDiv.innerHTML = `
                    <h5>${targetLeague}</h5>
                    <div class="preview-teams">
                        ${analyzedData.teams.map(team => `
                            <div class="preview-team">
                                <span class="team-name">${escapeHtml(team.name)}</span>
                                ${team.captainEmail ? `<span class="team-email"> data-user-email${escapeHtml(team.captainEmail)}</span>` : ''}
                                ${team.captainPhone ? `<span class="team-phone">${escapeHtml(team.captainPhone)}</span>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                previewList.appendChild(teamsDiv);
            }
            
            // Store analyzed data for import
            window.analyzedTeamsData = analyzedData;
        }

        async function performTeamsImport() {
            if (!window.analyzedTeamsData || !window.analyzedTeamsData.teams.length) {
                showToast('No data to import. Please analyze the source first.', 'warning');
                return;
            }
            
            const settings = getAdvancedSettings();
            addImportLogMessage('ðŸš€ Starting enhanced import process with advanced settings...');
            
            // Show preview if enabled
            if (settings.previewBeforeImport) {
                const confirmImport = await showImportPreview(window.analyzedTeamsData, settings);
                if (!confirmImport) {
                    addImportLogMessage('Import cancelled by user');
                    return;
                }
            }
            
            showImportProgress();
            updateImportProgress(0, 'Initializing sophisticated import engine...');
            
            try {
                const leagueSelection = document.querySelector('input[name="leagueSelection"]:checked').value;
                const defaultPaymentType = document.getElementById('defaultPaymentType').value;
                
                let targetLeagueId;
                
                // Enhanced league determination with validation
                if (leagueSelection === 'single') {
                    targetLeagueId = document.getElementById('targetLeague').value;
                    if (!targetLeagueId) {
                        throw new Error('Please select a target league');
                    }
                    addImportLogMessage(`âœ“ Target league selected: ${getLeagueName(targetLeagueId)}`);
                } else if (leagueSelection === 'new') {
                    const newLeagueName = document.getElementById('newLeagueName').value.trim();
                    if (!newLeagueName) {
                        throw new Error('Please enter a name for the new league');
                    }
                    
                    updateImportProgress(10, 'Creating new league with enhanced settings...');
                    targetLeagueId = await createNewLeague(newLeagueName);
                    addImportLogMessage(`âœ“ New league created: ${newLeagueName}`);
                }
                
                updateImportProgress(20, 'Applying intelligent team processing...');
                
                const importResults = {
                    imported: [],
                    skipped: [],
                    errors: [],
                    warnings: [],
                    duplicates: [],
                    enhanced: []
                };
                
                const existingTeamNames = new Set(teamsData.map(t => t.name.toLowerCase()));
                const processedNames = new Set();
                
                // Enhanced team processing with all advanced options
                for (let i = 0; i < window.analyzedTeamsData.teams.length; i++) {
                    const teamData = window.analyzedTeamsData.teams[i];
                    const progress = 20 + (60 * (i + 1) / window.analyzedTeamsData.teams.length);
                    
                    updateImportProgress(progress, `Processing: ${teamData.name} (${i + 1}/${window.analyzedTeamsData.teams.length})`);
                    
                    try {
                        // Enhanced team validation and processing
                        const processedTeam = await processTeamWithAdvancedSettings(teamData, settings, targetLeagueId, defaultPaymentType);
                        
                        if (!processedTeam) {
                            importResults.skipped.push(teamData.name);
                            continue;
                        }
                        
                        // Enhanced duplicate checking
                        const duplicateCheck = checkForDuplicates(processedTeam, existingTeamNames, processedNames, settings);
                        
                        if (duplicateCheck.isDuplicate) {
                            if (settings.skipDuplicates) {
                                importResults.duplicates.push({
                                    name: processedTeam.name,
                                    reason: duplicateCheck.reason
                                });
                                addImportLogMessage(`âš  Skipped duplicate: ${processedTeam.name} (${duplicateCheck.reason})`);
                                continue;
                            } else {
                                // Handle duplicate with smart resolution
                                processedTeam.name = await resolveDuplicateName(processedTeam.name, existingTeamNames, settings);
                                importResults.enhanced.push(`Renamed duplicate: ${teamData.name} â†’ ${processedTeam.name}`);
                            }
                        }
                        
                        // Final validation before import
                        const validation = await validateTeamForImport(processedTeam, settings);
                        if (!validation.isValid) {
                            importResults.errors.push({
                                team: processedTeam.name,
                                errors: validation.errors
                            });
                            addImportLogMessage(`âŒ Validation failed for ${processedTeam.name}: ${validation.errors.join(', ')}`);
                            continue;
                        }
                        
                        if (validation.warnings.length > 0) {
                            importResults.warnings.push({
                                team: processedTeam.name,
                                warnings: validation.warnings
                            });
                        }
                        
                        // Import successful team
                        teamsData.push(processedTeam);
                        importResults.imported.push(processedTeam);
                        existingTeamNames.add(processedTeam.name.toLowerCase());
                        processedNames.add(processedTeam.name.toLowerCase());
                        
                        addImportLogMessage(`âœ“ Successfully imported: ${processedTeam.name}`);
                        
                    } catch (teamError) {
                        importResults.errors.push({
                            team: teamData.name,
                            errors: [teamError.message]
                        });
                        
                        if (settings.enableErrorRecovery) {
                            addImportLogMessage(`âŒ Error processing ${teamData.name}: ${teamError.message} (continuing...)`);
                            continue;
                        } else {
                            throw teamError;
                        }
                    }
                    
                    // Small delay for smoother progress updates
                    await progressiveDelay(50, 100);
                }
                
                updateImportProgress(90, 'Finalizing import and updating system...');
                
                // Save the updated teams data
                await window.UserDataManager.saveTeams(teamsData);
                
                updateImportProgress(100, 'Import completed successfully!');
                
                // Generate comprehensive import report
                const report = generateImportReport(importResults, settings, window.analyzedTeamsData);
                displayImportReport(report);
                
                // Update UI
                setTimeout(() => {
                    renderTeamsTable();
                    hideImportProgress();
                    closeImportTeamsModal();
                    showEnhancedSuccessMessage(report);
                }, 1000);
                
            } catch (error) {
                updateImportProgress(100, `Import failed: ${error.message}`);
                addImportLogMessage(`ðŸ’¥ Import failed: ${error.message}`);
                showToast(`Import failed: ${error.message}`, 'error');
                
                setTimeout(() => {
                    hideImportProgress();
                }, 2000);
            }
        }

        // ===== ENHANCED IMPORT HELPER FUNCTIONS =====
        
        async function showImportPreview(analyzedData, settings) {
            return new Promise((resolve) => {
                const previewModal = createPreviewModal(analyzedData, settings);
                document.body.appendChild(previewModal);
                
                const confirmBtn = previewModal.querySelector('.confirm-import');
                const cancelBtn = previewModal.querySelector('.cancel-import');
                
                confirmBtn.onclick = () => {
                    document.body.removeChild(previewModal);
                    resolve(true);
                };
                
                cancelBtn.onclick = () => {
                    document.body.removeChild(previewModal);
                    resolve(false);
                };
            });
        }
        
        function createPreviewModal(analyzedData, settings) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal-content large-modal">
                    <div class="modal-header">
                        <h3>Import Preview</h3>
                    </div>
                    <div class="modal-body">
                        <div class="preview-summary">
                            <h4>Import Summary</h4>
                            <p><strong>Total Teams:</strong> ${analyzedData.teams.length}</p>
                            <p><strong>Source:</strong> ${analyzedData.content?.venue || 'External Source'}</p>
                            <p><strong>Settings:</strong> ${Object.entries(settings).filter(([k,v]) => v === true).map(([k]) => k).join(', ')}</p>
                        </div>
                        <div class="teams-preview">
                            <h4>Teams to Import</h4>
                            <div class="teams-list">
                                ${analyzedData.teams.slice(0, 10).map(team => `
                                    <div class="team-preview-item">
                                        <strong>${team.name}</strong>
                                        <span class="team-league">${team.league}</span>
                                    </div>
                                `).join('')}
                                ${analyzedData.teams.length > 10 ? `<p>... and ${analyzedData.teams.length - 10} more teams</p>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary cancel-import">Cancel</button>
                        <button class="btn btn-primary confirm-import">Confirm Import</button>
                    </div>
                </div>
            `;
            return modal;
        }
        
        async function processTeamWithAdvancedSettings(teamData, settings, targetLeagueId, defaultPaymentType) {
            // Validate team name length
            if (teamData.name.length < settings.minimumTeamNameLength || 
                teamData.name.length > settings.maximumTeamNameLength) {
                return null;
            }
            
            let processedName = teamData.name;
            
            // Apply smart matching if enabled
            if (settings.enableSmartMatching) {
                processedName = applySmartMatching(processedName);
            }
            
            // Validate and clean team name if enabled
            if (settings.validateTeamNames) {
                processedName = validateTeamName(processedName, settings);
            }
            
            const team = {
                id: generateTeamId(),
                name: processedName,
                leagueId: targetLeagueId,
                status: settings.setDefaultStatus ? 'Pending' : 'Active',
                captainName: teamData.captainName || '',
                captainEmail: teamData.captainEmail || '',
                captainPhone: teamData.captainPhone || '',
                emergencyContact: '',
                paymentType: defaultPaymentType || '',
                paymentStatus: 'pending',
                preferredTimeSlots: [],
                communicationPreferences: [],
                notes: `Imported from ${teamData.source || 'external source'} on ${new Date().toLocaleDateString()}`,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                originalName: teamData.name,
                importSettings: settings
            };
            
            // Auto-generate abbreviation if enabled
            if (settings.autoGenerateAbbreviations) {
                team.abbreviation = generateTeamAbbreviation(team.name);
            }
            
            // Extract contact info if enabled
            if (settings.extractContactInfo && teamData.contact) {
                team.captainEmail = teamData.contact.email || team.captainEmail;
                team.captainPhone = teamData.contact.phone || team.captainPhone;
            }
            
            return team;
        }
        
        function checkForDuplicates(team, existingNames, processedNames, settings) {
            const teamNameLower = team.name.toLowerCase();
            
            if (existingNames.has(teamNameLower)) {
                return { isDuplicate: true, reason: 'exists in system' };
            }
            
            if (processedNames.has(teamNameLower)) {
                return { isDuplicate: true, reason: 'duplicate in import batch' };
            }
            
            // Check for similar names if smart matching is enabled
            if (settings.enableSmartMatching) {
                for (const existingName of existingNames) {
                    if (calculateSimilarity(teamNameLower, existingName) > 0.8) {
                        return { isDuplicate: true, reason: `similar to "${existingName}"` };
                    }
                }
            }
            
            return { isDuplicate: false };
        }
        
        async function resolveDuplicateName(originalName, existingNames, settings) {
            let counter = 1;
            let newName = `${originalName} (${counter})`;
            
            while (existingNames.has(newName.toLowerCase())) {
                counter++;
                newName = `${originalName} (${counter})`;
            }
            
            return newName;
        }
        
        async function validateTeamForImport(team, settings) {
            const errors = [];
            const warnings = [];
            
            // Required field validation
            if (!team.name || team.name.trim().length === 0) {
                errors.push('Team name is required');
            }
            
            if (!team.leagueId) {
                errors.push('League assignment is required');
            }
            
            // Name length validation
            if (team.name.length < settings.minimumTeamNameLength) {
                errors.push(`Team name too short (minimum ${settings.minimumTeamNameLength} characters)`);
            }
            
            if (team.name.length > settings.maximumTeamNameLength) {
                errors.push(`Team name too long (maximum ${settings.maximumTeamNameLength} characters)`);
            }
            
            // Contact validation warnings
            if (settings.extractContactInfo) {
                if (!team.captainEmail && !team.captainPhone) {
                    warnings.push('No contact information available');
                }
                
                if (team.captainEmail && !isValidEmail(team.captainEmail)) {
                    warnings.push('Email format appears invalid');
                }
            }
            
            return {
                isValid: errors.length === 0,
                errors,
                warnings
            };
        }
        
        function generateImportReport(results, settings, originalData) {
            return {
                timestamp: new Date().toISOString(),
                settings: settings,
                originalData: {
                    totalTeams: originalData.teams.length,
                    source: originalData.content?.venue || 'External Source'
                },
                results: {
                    imported: results.imported.length,
                    skipped: results.skipped.length,
                    errors: results.errors.length,
                    warnings: results.warnings.length,
                    duplicates: results.duplicates.length,
                    enhanced: results.enhanced.length
                },
                details: results,
                quality: {
                    successRate: (results.imported.length / originalData.teams.length * 100).toFixed(1),
                    errorRate: (results.errors.length / originalData.teams.length * 100).toFixed(1)
                }
            };
        }
        
        function displayImportReport(report) {
            const summaryMessage = `
Import Complete! 
âœ“ ${report.results.imported} teams imported successfully
âš  ${report.results.skipped} teams skipped
âŒ ${report.results.errors} errors encountered
ðŸ“Š Success rate: ${report.quality.successRate}%
            `.trim();
            
            addImportLogMessage('ðŸ“‹ === IMPORT REPORT ===');
            addImportLogMessage(summaryMessage);
            
            if (report.details.enhanced.length > 0) {
                addImportLogMessage('ðŸŽ¯ Enhanced processing applied:');
                report.details.enhanced.forEach(enhancement => {
                    addImportLogMessage(`  â€¢ ${enhancement}`);
                });
            }
            
            if (report.details.duplicates.length > 0) {
                addImportLogMessage('âš  Duplicates handled:');
                report.details.duplicates.forEach(dup => {
                    addImportLogMessage(`  â€¢ ${dup.name} (${dup.reason})`);
                });
            }
        }
        
        function showEnhancedSuccessMessage(report) {
            const message = `Successfully imported ${report.results.imported} teams with ${report.quality.successRate}% success rate`;
            showToast(message, 'success');
        }
        
        function getLeagueName(leagueId) {
            const league = leaguesData.find(l => l.id === leagueId);
            return league ? league.name : 'Unknown League';
        }
        
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }
        
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // ===== END ENHANCED IMPORT HELPERS =====

        async function createNewLeague(leagueName) {
            // Create a new league and return its ID
            const newLeague = {
                id: `league_${Date.now()}`,
                name: leagueName,
                description: `League created during team import on ${new Date().toLocaleDateString()}`,
                status: 'active',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            leaguesData.push(newLeague);
            
            // Save leagues data (assuming similar save function exists)
            try {
                await window.UserDataManager.saveData('leagues', leaguesData);
                addImportLogMessage(`Created new league: ${leagueName}`);
                return newLeague.id;
            } catch (error) {
                throw new Error(`Failed to create new league: ${error.message}`);
            }
        }

        function generateTeamId() {
            return `team_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        function generateAbbreviation(teamName) {
            return teamName
                .split(' ')
                .map(word => word.charAt(0).toUpperCase())
                .join('')
                .substr(0, 4);
        }

        function validateImportForm() {
            const importType = document.querySelector('input[name="importType"]:checked').value;
            
            if (importType === 'url') {
                const url = document.getElementById('importUrl').value.trim();
                if (!url) {
                    showToast('Please enter a URL', 'warning');
                    return false;
                }
                
                try {
                    new URL(url);
                } catch {
                    showToast('Please enter a valid URL', 'warning');
                    return false;
                }
            } else {
                const file = document.getElementById('importFile').files[0];
                if (!file) {
                    showToast('Please select a file to upload', 'warning');
                    return false;
                }
            }
            
            const leagueSelection = document.querySelector('input[name="leagueSelection"]:checked').value;
            if (leagueSelection === 'single') {
                const targetLeague = document.getElementById('targetLeague').value;
                if (!targetLeague) {
                    showToast('Please select a target league', 'warning');
                    return false;
                }
            } else if (leagueSelection === 'new') {
                const newLeagueName = document.getElementById('newLeagueName').value.trim();
                if (!newLeagueName) {
                    showToast('Please enter a name for the new league', 'warning');
                    return false;
                }
            }
            
            return true;
        }

        function showImportProgress() {
            document.getElementById('importProgressSection').style.display = 'block';
            document.getElementById('importLog').innerHTML = '';
        }

        function hideImportProgress() {
            document.getElementById('importProgressSection').style.display = 'none';
        }

        function showPreviewSection() {
            document.getElementById('previewSection').style.display = 'block';
        }

        function hidePreviewSection() {
            document.getElementById('previewSection').style.display = 'none';
        }

        function updateImportProgress(percentage, message) {
            document.getElementById('importProgressBar').style.width = percentage + '%';
            document.getElementById('importProgressText').textContent = percentage + '%';
            document.getElementById('importStatusText').textContent = message;
        }

        function addImportLogMessage(message) {
            const log = document.getElementById('importLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">${timestamp}</span> ${escapeHtml(message)}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }
        
        // Filter teams function
        function filterTeams() {
            const searchTerm = document.getElementById('teamSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            const leagueFilter = document.getElementById('leagueFilter')?.value || 'all';
            
            filteredTeamsData = teamsData.filter(team => {
                const nameMatch = team.name.toLowerCase().includes(searchTerm);
                const statusMatch = statusFilter === 'all' || team.status === statusFilter;
                const leagueMatch = leagueFilter === 'all' || team.leagueId === leagueFilter;
                
                return nameMatch && statusMatch && leagueMatch;
            });
            
            renderTeamsList();
        }
        
        // ===== GLOBAL FUNCTION DECLARATIONS =====
        // Create missing functions
        function handleLogout(event) {
            event.preventDefault();
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '../../login.html';
            }
        }
        
        // Make all onclick handler functions globally accessible
        window.closeTeamModal = closeTeamModal;
        window.saveTeam = saveTeam;
        window.closeExportTeamsModal = closeExportTeamsModal;
        window.performTeamsExport = performTeamsExport;
        window.closeTeamDetailsModal = closeTeamDetailsModal;
        window.editTeamFromDetails = editTeamFromDetails;
        window.analyzeImportSource = analyzeImportSource;
        window.performTeamsImport = performTeamsImport;
        window.viewTeamDetails = viewTeamDetails;
        window.editTeam = editTeam;
        window.deleteTeam = deleteTeam;
        window.handleLogout = handleLogout;
        
        // Additional utility functions that might be needed
        window.filterTeams = filterTeams;
        window.renderTeamsList = renderTeamsList;
        window.updateOverviewCards = updateOverviewCards;
        
        console.log('All teams management functions made globally accessible');

    </script>
    
    <!-- Essential Scripts for Teams Management -->
    <script src="../../app.js"></script>
    <script src="../../auth.js"></script>`n    <script src="../../js/core/session-manager.js"></script>
    
    <!-- UserDataManager Fallback -->
    <script>
        // Create UserDataManager if not available
        if (!window.UserDataManager) {
            window.UserDataManager = {
                async load() {
                    try {
                        const data = localStorage.getItem('5iveTrackrData');
                        return data ? JSON.parse(data) : { teams: [], leagues: [] };
                    } catch (error) {
                        console.error('Error loading data:', error);
                        return { teams: [], leagues: [] };
                    }
                },
                
                async save(data) {
                    try {
                        localStorage.setItem('5iveTrackrData', JSON.stringify(data));
                        return { success: true };
                    } catch (error) {
                        console.error('Error saving data:', error);
                        throw error;
                    }
                },
                
                async saveTeams(teams) {
                    try {
                        const data = await this.load();
                        data.teams = teams;
                        return await this.save(data);
                    } catch (error) {
                        console.error('Error saving teams:', error);
                        throw error;
                    }
                },
                
                async saveData(key, value) {
                    try {
                        const data = await this.load();
                        data[key] = value;
                        return await this.save(data);
                    } catch (error) {
                        console.error(`Error saving ${key}:`, error);
                        throw error;
                    }
                }
            };
            
            console.log('UserDataManager fallback initialized');
        }
    </script>
    
    <!-- Toast Notification System -->
    <script>
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <span class="toast-message">${message}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
                </div>
            `;
            
            // Add toast styles if not already present
            if (!document.querySelector('#toast-styles')) {
                const styles = document.createElement('style');
                styles.id = 'toast-styles';
                styles.textContent = `
                    .toast {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        min-width: 300px;
                        padding: 16px;
                        border-radius: 8px;
                        color: white;
                        font-weight: 500;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        animation: slideInRight 0.3s ease-out;
                    }
                    .toast-info { background: #3b82f6; }
                    .toast-success { background: #10b981; }
                    .toast-warning { background: #f59e0b; }
                    .toast-error { background: #ef4444; }
                    .toast-content {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        gap: 12px;
                    }
                    .toast-close {
                        background: none;
                        border: none;
                        color: white;
                        font-size: 18px;
                        cursor: pointer;
                        padding: 0;
                        line-height: 1;
                    }
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>


